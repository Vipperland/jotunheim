<?php
/**
 * Generated by Haxe 4.3.0
 */

namespace jotun\modules;

use \php\_Boot\HxAnon;
use \php\Boot;
use \haxe\Exception;
use \jotun\utils\Filler;
use \jotun\Jotun;
use \jotun\utils\Dice;
use \sys\io\File;
use \haxe\Json;
use \php\_Boot\HxString;

/**
 * ...
 * @author Rafael Moreira <vipperland@live.com,rafael@gateofsirius.com>
 */
class ModLib {
	/**
	 * @var mixed
	 */
	static public $CACHE;
	/**
	 * @var mixed
	 */
	static public $DATA;
	/**
	 * @var bool
	 */
	static public $_init;

	/**
	 * @var \Closure[]|\Array_hx
	 */
	public $_predata;

	/**
	 * @return void
	 */
	public function __construct () {
		#src/jotun/modules/ModLib.hx:67: lines 67-72
		if (ModLib::$_init !== true) {
			#src/jotun/modules/ModLib.hx:68: characters 4-16
			ModLib::$_init = true;
			#src/jotun/modules/ModLib.hx:69: characters 4-17
			$this->_predata = new \Array_hx();
		} else {
			#src/jotun/modules/ModLib.hx:71: characters 4-9
			throw new \Error("Can't create instance of ModLib. Use Jotun.resources instead of new ModLib().");
		}
	}

	/**
	 * @param string $name
	 * @param mixed $data
	 * 
	 * @return mixed
	 */
	public function _sanitize ($name, $data) {
		#src/jotun/modules/ModLib.hx:62: characters 3-89
		Dice::Values($this->_predata, function ($v) use (&$name, &$data) {
			#src/jotun/modules/ModLib.hx:62: characters 64-84
			$data = $v($name, $data);
		});
		#src/jotun/modules/ModLib.hx:63: characters 3-14
		return $data;
	}

	/**
	 * @param string $name
	 * 
	 * @return mixed
	 */
	public function buffer ($name = null) {
		#src/jotun/modules/ModLib.hx:339: lines 339-343
		if (($name !== null) && ($name !== "")) {
			#src/jotun/modules/ModLib.hx:340: characters 4-36
			return \Reflect::field(ModLib::$DATA, $name);
		} else {
			#src/jotun/modules/ModLib.hx:342: characters 4-22
			return Boot::dynamicField(ModLib::$DATA, 'buffer');
		}
	}

	/**
	 * Check if a plugins exists
	 * @param	module
	 * @return
	 * 
	 * @param string $module
	 * 
	 * @return bool
	 */
	public function exists ($module) {
		#src/jotun/modules/ModLib.hx:91: characters 3-32
		$module = \mb_strtolower($module);
		#src/jotun/modules/ModLib.hx:92: characters 3-41
		return \Reflect::hasField(ModLib::$CACHE, $module);
	}

	/**
	 * Write module with custom data in the flow to be imported by Jotun Client
	 * @param	name
	 * @param	data
	 * @param	repeat
	 * @param	sufix
	 * 
	 * @param mixed $name
	 * @param mixed $data
	 * 
	 * @return void
	 */
	public function export ($name, $data = null) {
		#src/jotun/modules/ModLib.hx:380: lines 380-399
		$_gthis = $this;
		#src/jotun/modules/ModLib.hx:381: characters 4-38
		echo("<noscript jtn-module>");
		#src/jotun/modules/ModLib.hx:382: lines 382-397
		if (($name instanceof \Array_hx)) {
			#src/jotun/modules/ModLib.hx:383: lines 383-393
			Dice::Values($name, function ($v) use (&$name, &$data, &$_gthis) {
				#src/jotun/modules/ModLib.hx:384: lines 384-392
				if (is_string($v)) {
					#src/jotun/modules/ModLib.hx:385: characters 7-54
					echo(\Std::string("[Module:{\"name\":\"" . \Std::string($name) . "\"}]\x0D"));
					#src/jotun/modules/ModLib.hx:386: characters 7-29
					$_gthis->print($_gthis->get($name, $data));
				} else if (\Reflect::hasField($v, "info")) {
					#src/jotun/modules/ModLib.hx:388: characters 7-28
					echo("[Module:");
					#src/jotun/modules/ModLib.hx:389: characters 7-40
					echo(\Std::string(Json::phpJsonEncode(Boot::dynamicField($v, 'info'), null, null)));
					#src/jotun/modules/ModLib.hx:390: characters 7-23
					echo("]\x0D");
					#src/jotun/modules/ModLib.hx:391: characters 7-28
					$_gthis->print(Boot::dynamicField($v, 'name'), Boot::dynamicField($v, 'data'));
				}
			});
		} else {
			#src/jotun/modules/ModLib.hx:395: characters 5-52
			echo(\Std::string("[Module:{\"name\":\"" . \Std::string($name) . "\"}]\x0D"));
			#src/jotun/modules/ModLib.hx:396: characters 5-20
			$this->get($name, $data);
		}
		#src/jotun/modules/ModLib.hx:398: characters 4-28
		echo("</noscript>");
	}

	/**
	 * Get module content
	 * @param	name
	 * @param	data
	 * @param	alt
	 * @return
	 * 
	 * @param string $name
	 * @param mixed $data
	 * @param string $alt
	 * 
	 * @return string
	 */
	public function get ($name, $data = null, $alt = null) {
		#src/jotun/modules/ModLib.hx:302: characters 3-28
		$name = \mb_strtolower($name);
		#src/jotun/modules/ModLib.hx:303: lines 303-305
		if (!$this->exists($name)) {
			#src/jotun/modules/ModLib.hx:304: characters 11-122
			if ($alt !== null) {
				#src/jotun/modules/ModLib.hx:304: characters 25-28
				return $alt;
			} else {
				#src/jotun/modules/ModLib.hx:304: characters 31-122
				return "<span style='color:#ff0000;font-weight:bold;'>Undefined [Module:" . ($name??'null') . "]</span><br/>";
			}
		}
		#src/jotun/modules/ModLib.hx:306: characters 3-51
		$content = \Reflect::field(ModLib::$CACHE, $name);
		#src/jotun/modules/ModLib.hx:307: characters 3-31
		$data = $this->_sanitize($name, $data);
		#src/jotun/modules/ModLib.hx:308: characters 10-61
		if ($data !== null) {
			#src/jotun/modules/ModLib.hx:308: characters 27-51
			return Filler::to($content, $data);
		} else {
			#src/jotun/modules/ModLib.hx:308: characters 54-61
			return $content;
		}
	}

	/**
	 * @param string $name
	 * 
	 * @return string
	 */
	public function image ($name) {
		#src/jotun/modules/ModLib.hx:335: characters 3-42
		return \Reflect::field(Boot::dynamicField(ModLib::$DATA, 'images'), $name);
	}

	/**
	 * Get module content as json object
	 * @param	name
	 * @param	data
	 * @return
	 * 
	 * @param string $name
	 * @param mixed $data
	 * 
	 * @return mixed
	 */
	public function object ($name, $data = null) {
		#src/jotun/modules/ModLib.hx:318: lines 318-330
		if (\Reflect::hasField(ModLib::$DATA, $name)) {
			#src/jotun/modules/ModLib.hx:319: characters 4-36
			$data = \Reflect::field(ModLib::$DATA, $name);
		} else {
			#src/jotun/modules/ModLib.hx:321: characters 4-41
			$val = $this->get($name, $data, "");
			#src/jotun/modules/ModLib.hx:322: lines 322-329
			if ($val !== null) {
				#src/jotun/modules/ModLib.hx:323: lines 323-328
				try {
					#src/jotun/modules/ModLib.hx:324: characters 6-28
					$data = Json::phpJsonDecode($val);
				} catch(\Throwable $_g) {
					#src/jotun/modules/ModLib.hx:326: characters 6-89
					Jotun::log("\x09ModLib => Can't create object for [Module:" . ($name??'null') . "]", 3);
					#src/jotun/modules/ModLib.hx:327: characters 6-17
					$data = null;
				}
			}
		}
		#src/jotun/modules/ModLib.hx:331: characters 3-14
		return $data;
	}

	/**
	 * Pre filter all get data
	 * @param	handler
	 * 
	 * @param \Closure $handler
	 * 
	 * @return void
	 */
	public function onDataRequest ($handler) {
		#src/jotun/modules/ModLib.hx:80: lines 80-82
		if (\Lambda::indexOf($this->_predata, $handler) === -1) {
			#src/jotun/modules/ModLib.hx:81: characters 4-39
			$this->_predata->offsetSet($this->_predata->length, $handler);
		}
	}

	/**
	 * Cache a file to post write
	 * @param	file
	 * @return
	 * 
	 * @param string $file
	 * 
	 * @return bool
	 */
	public function prepare ($file) {
		#src/jotun/modules/ModLib.hx:355: characters 8-47
		$tmp = null;
		if ($file !== null) {
			#src/jotun/modules/ModLib.hx:355: characters 24-47
			\clearstatcache(true, $file);
			#src/jotun/modules/ModLib.hx:355: characters 8-47
			$tmp = \file_exists($file);
		} else {
			$tmp = false;
		}
		#src/jotun/modules/ModLib.hx:355: lines 355-358
		if ($tmp) {
			#src/jotun/modules/ModLib.hx:356: characters 5-42
			$this->register($file, File::getContent($file));
			#src/jotun/modules/ModLib.hx:357: characters 5-16
			return true;
		}
		#src/jotun/modules/ModLib.hx:359: characters 4-16
		return false;
	}

	/**
	 * Write module and fill with custom data in the flow
	 * @param	name
	 * @param	data
	 * @param	repeat
	 * @param	sufix
	 * 
	 * @param string $name
	 * @param mixed $data
	 * 
	 * @return void
	 */
	public function print ($name, $data = null) {
		#src/jotun/modules/ModLib.hx:370: characters 4-30
		echo(\Std::string($this->get($name, $data)));
	}

	/**
	 * Register a module
	 * @param	file
	 * @param	content
	 * @param	data
	 * 
	 * @param string $file
	 * @param string $content
	 * 
	 * @return void
	 */
	public function register ($file, $content) {
		#src/jotun/modules/ModLib.hx:107: lines 107-292
		$_gthis = $this;
		#src/jotun/modules/ModLib.hx:108: characters 3-55
		$content = HxString::split($content, "[module:{")->join("[!MOD!]");
		#src/jotun/modules/ModLib.hx:109: characters 3-55
		$content = HxString::split($content, "[Module:{")->join("[!MOD!]");
		#src/jotun/modules/ModLib.hx:110: characters 3-52
		$sur = HxString::split($content, "[!MOD!]");
		#src/jotun/modules/ModLib.hx:111: lines 111-291
		if ($sur->length > 1) {
			#src/jotun/modules/ModLib.hx:112: characters 4-57
			Jotun::log("ModLib => PARSING " . ($file??'null'), 1);
			#src/jotun/modules/ModLib.hx:116: lines 116-247
			Dice::All($sur, function ($p, $v) use (&$file, &$_gthis, &$content) {
				#src/jotun/modules/ModLib.hx:117: lines 117-245
				if ($p > 0) {
					#src/jotun/modules/ModLib.hx:118: characters 6-34
					$i = HxString::indexOf($v, "}]");
					#src/jotun/modules/ModLib.hx:119: lines 119-244
					if ($i !== -1) {
						#src/jotun/modules/ModLib.hx:120: characters 7-61
						$mod = Json::phpJsonDecode("{" . (\mb_substr($v, 0, $i)??'null') . "}");
						#src/jotun/modules/ModLib.hx:121: characters 7-30
						$path = $file;
						#src/jotun/modules/ModLib.hx:122: lines 122-130
						if ($mod->name === null) {
							#src/jotun/modules/ModLib.hx:123: characters 8-23
							$mod->name = $file;
						} else if ($mod->name === "[]") {
							#src/jotun/modules/ModLib.hx:125: characters 8-20
							$path = ($path??'null') . "[]";
							#src/jotun/modules/ModLib.hx:126: characters 8-56
							Jotun::log("\x09\x09@ PUSH " . ($mod->name??'null'), 1);
						} else {
							#src/jotun/modules/ModLib.hx:128: characters 8-30
							$path = ($path??'null') . "#" . ($mod->name??'null');
							#src/jotun/modules/ModLib.hx:129: characters 8-56
							Jotun::log("\x09\x09@ NAME " . ($mod->name??'null'), 1);
						}
						#src/jotun/modules/ModLib.hx:131: lines 131-133
						if ($_gthis->exists($mod->name)) {
							#src/jotun/modules/ModLib.hx:132: characters 8-70
							Jotun::log("\x09ModLib => !!! OVERRIDING " . ($path??'null'), 2);
						}
						#src/jotun/modules/ModLib.hx:134: characters 7-40
						$end = HxString::indexOf($v, "/EOF;");
						#src/jotun/modules/ModLib.hx:135: characters 17-81
						$content = \trim(HxString::substring($v, $i + 2, ($end === -1 ? mb_strlen($v) : $end)));
						#src/jotun/modules/ModLib.hx:136: lines 136-144
						if (($mod->type === null) || ($mod->type === "null") || ($mod->type === "html")) {
							#src/jotun/modules/ModLib.hx:137: characters 8-73
							$content = HxString::split(HxString::split($content, "\x0D\x0A")->join("\x0A"), "\x0D")->join("\x0A");
							#src/jotun/modules/ModLib.hx:138: lines 138-140
							while (\mb_substr($content, 0, 1) === "\x0D") {
								#src/jotun/modules/ModLib.hx:139: characters 9-55
								$content = HxString::substring($content, 1, mb_strlen($content));
							}
							#src/jotun/modules/ModLib.hx:141: lines 141-143
							while (\mb_substr($content, -1, null) === "\x0A") {
								#src/jotun/modules/ModLib.hx:142: characters 9-59
								$content = HxString::substring($content, 0, mb_strlen($content) - 1);
							}
						}
						#src/jotun/modules/ModLib.hx:145: lines 145-171
						if ($mod->require !== null) {
							#src/jotun/modules/ModLib.hx:146: characters 8-42
							$incT = $mod->require->length;
							#src/jotun/modules/ModLib.hx:147: characters 8-25
							$incC = 1;
							#src/jotun/modules/ModLib.hx:148: characters 8-89
							Jotun::log("\x09\x09\x09INCLUDING MODULES IN '" . ($path??'null') . "' (" . ($incT??'null') . ")", 1);
							#src/jotun/modules/ModLib.hx:149: lines 149-170
							Dice::Values($mod->require, function ($v) use (&$incT, &$incC, &$_gthis, &$content) {
								#src/jotun/modules/ModLib.hx:150: lines 150-168
								if ($_gthis->exists($v)) {
									#src/jotun/modules/ModLib.hx:152: lines 152-162
									Dice::All(HxString::split($content, "{{@include:" . ($v??'null') . ",data:"), function ($p, $v2) use (&$_gthis, &$content, &$v) {
										#src/jotun/modules/ModLib.hx:153: lines 153-161
										if ($p > 0) {
											#src/jotun/modules/ModLib.hx:154: characters 12-56
											$pieces = ((HxString::split($v2, "}}")->arr[0] ?? null)??'null') . "}";
											#src/jotun/modules/ModLib.hx:155: lines 155-160
											try {
												#src/jotun/modules/ModLib.hx:156: characters 13-51
												$data = Json::phpJsonDecode($pieces);
												#src/jotun/modules/ModLib.hx:157: characters 13-101
												$content = HxString::split($content, "{{@include:" . ($v??'null') . ",data:" . ($pieces??'null') . "}}")->join($_gthis->get($v, $data));
											} catch(\Error $e) {
												#src/jotun/modules/ModLib.hx:159: characters 13-99
												Jotun::log("\x09\x09\x09\x09ERROR: Can't parse module injection data for " . ($v??'null') . ".", 3);
											}
										}
									});
									#src/jotun/modules/ModLib.hx:164: characters 10-72
									$content = HxString::split($content, "{{@include:" . ($v??'null') . "}}")->join($_gthis->get($v));
									#src/jotun/modules/ModLib.hx:165: characters 10-92
									Jotun::log("\x09\x09\x09\x09@ INCLUDED '" . ($v??'null') . "' (" . ($incC??'null') . "/" . ($incT??'null') . ")", 1);
								} else {
									#src/jotun/modules/ModLib.hx:167: characters 10-90
									Jotun::log("\x09\x09\x09\x09@ MISSING '" . ($v??'null') . "' (" . ($incC??'null') . "/" . ($incT??'null') . ")", 3);
								}
								#src/jotun/modules/ModLib.hx:169: characters 9-15
								$incC += 1;
							});
						}
						#src/jotun/modules/ModLib.hx:172: lines 172-197
						if ($mod->inject !== null) {
							#src/jotun/modules/ModLib.hx:173: characters 8-42
							$injT = $mod->require->length;
							#src/jotun/modules/ModLib.hx:174: characters 8-25
							$injC = 1;
							#src/jotun/modules/ModLib.hx:175: characters 8-89
							Jotun::log("\x09\x09\x09INJECTING MODULES IN '" . ($path??'null') . "' (" . ($injT??'null') . ")", 1);
							#src/jotun/modules/ModLib.hx:176: lines 176-196
							Dice::Values($mod->inject, function ($v) use (&$mod, &$_gthis, &$content, &$injC, &$injT) {
								#src/jotun/modules/ModLib.hx:177: lines 177-195
								if ($_gthis->exists($v)) {
									#src/jotun/modules/ModLib.hx:179: lines 179-189
									Dice::All(HxString::split($content, "{{@inject:" . ($v??'null') . ",data:"), function ($p, $v2) use (&$_gthis, &$content, &$v) {
										#src/jotun/modules/ModLib.hx:180: lines 180-188
										if ($p > 0) {
											#src/jotun/modules/ModLib.hx:181: characters 12-56
											$pieces = ((HxString::split($v2, "}}")->arr[0] ?? null)??'null') . "}";
											#src/jotun/modules/ModLib.hx:182: lines 182-187
											try {
												#src/jotun/modules/ModLib.hx:183: characters 13-51
												$data = Json::phpJsonDecode($pieces);
												#src/jotun/modules/ModLib.hx:184: characters 13-100
												$content = HxString::split($_gthis->get($v, $data), "{{@inject:" . ($v??'null') . ",data:" . ($pieces??'null') . "}}")->join($content);
											} catch(\Error $e) {
												#src/jotun/modules/ModLib.hx:186: characters 13-99
												Jotun::log("\x09\x09\x09\x09ERROR: Can't parse module injection data for " . ($v??'null') . ".", 3);
											}
										}
									});
									#src/jotun/modules/ModLib.hx:191: characters 10-78
									$content = HxString::split($_gthis->get($v), "{{@inject:" . ($mod->name??'null') . "}}")->join($content);
									#src/jotun/modules/ModLib.hx:192: characters 10-80
									Jotun::log("\x09\x09\x09\x09@ INJECTED '" . ($v??'null') . "' (" . ($injC??'null') . "/" . ($injT??'null') . ")", 1);
								} else {
									#src/jotun/modules/ModLib.hx:194: characters 10-90
									Jotun::log("\x09\x09\x09\x09@ MISSING '" . ($v??'null') . "' (" . ($injC??'null') . "/" . ($injT??'null') . ")", 3);
								}
							});
						}
						#src/jotun/modules/ModLib.hx:198: lines 198-201
						if ($mod->data !== null) {
							#src/jotun/modules/ModLib.hx:199: characters 19-39
							$tmp = Json::phpJsonDecode($mod->data);
							#src/jotun/modules/ModLib.hx:199: characters 8-39
							$mod->data = $tmp;
							#src/jotun/modules/ModLib.hx:200: characters 8-46
							$content = Filler::to($content, $mod->data);
						}
						#src/jotun/modules/ModLib.hx:202: lines 202-206
						if ($mod->replace !== null) {
							#src/jotun/modules/ModLib.hx:203: lines 203-205
							Dice::Values($mod->replace, function ($v) use (&$content) {
								#src/jotun/modules/ModLib.hx:204: characters 9-49
								$content = HxString::split($content, ($v->arr[0] ?? null))->join(($v->arr[1] ?? null));
							});
						}
						#src/jotun/modules/ModLib.hx:207: lines 207-231
						if ($mod->type !== null) {
							#src/jotun/modules/ModLib.hx:208: lines 208-230
							if ($mod->type === "data") {
								#src/jotun/modules/ModLib.hx:209: lines 209-219
								try {
									#src/jotun/modules/ModLib.hx:210: characters 10-39
									$content = Json::phpJsonDecode($content);
									#src/jotun/modules/ModLib.hx:211: lines 211-215
									if ($mod->name === "[]") {
										#src/jotun/modules/ModLib.hx:212: characters 11-36
										Boot::dynamicField(ModLib::$DATA, 'buffer')->push($content);
									} else {
										#src/jotun/modules/ModLib.hx:214: characters 11-52
										\Reflect::setField(ModLib::$DATA, $mod->name, $content);
									}
									#src/jotun/modules/ModLib.hx:216: characters 10-22
									return false;
								} catch(\Throwable $_g) {
									#src/jotun/modules/ModLib.hx:217: characters 17-18
									$e = Exception::caught($_g)->unwrap();
									#src/jotun/modules/ModLib.hx:218: characters 10-110
									Jotun::log("\x09\x09\x09ERROR! Can't parse DATA[" . ($mod->name??'null') . "] \x0A\x0A " . ($content??'null') . "\x0A\x0A" . \Std::string($e), 3);
								}
							} else if ($mod->type === "image") {
								#src/jotun/modules/ModLib.hx:229: characters 9-57
								\Reflect::setField(Boot::dynamicField(ModLib::$DATA, 'images'), $mod->name, $content);
							}
						}
						#src/jotun/modules/ModLib.hx:239: characters 7-45
						$n = \mb_strtolower($mod->name);
						#src/jotun/modules/ModLib.hx:240: characters 7-42
						\Reflect::setField(ModLib::$CACHE, $n, $content);
						#src/jotun/modules/ModLib.hx:241: characters 7-45
						\Reflect::setField(ModLib::$CACHE, "@" . ($n??'null'), $path);
					} else {
						#src/jotun/modules/ModLib.hx:243: characters 7-99
						Jotun::log("\x09ModLib => CONFIG ERROR " . ($file??'null') . "(" . (\mb_substr($v, 0, 15)??'null') . "...)", 3);
					}
				}
				#src/jotun/modules/ModLib.hx:246: characters 5-17
				return false;
			});
		} else {
			#src/jotun/modules/ModLib.hx:289: characters 5-57
			\Reflect::setField(ModLib::$CACHE, \mb_strtolower($file), $content);
		}
	}

	/**
	 * @param string $module
	 * 
	 * @return void
	 */
	public function remove ($module) {
		#src/jotun/modules/ModLib.hx:96: lines 96-98
		if ($this->exists($module)) {
			#src/jotun/modules/ModLib.hx:97: characters 4-38
			\Reflect::deleteField(ModLib::$CACHE, $module);
		}
	}

	/**
	 * @internal
	 * @access private
	 */
	static public function __hx__init ()
	{
		static $called = false;
		if ($called) return;
		$called = true;


		self::$CACHE = new HxAnon();
		self::$DATA = new HxAnon([
			"buffer" => new \Array_hx(),
			"images" => new HxAnon(),
		]);
	}
}

Boot::registerClass(ModLib::class, 'jotun.modules.ModLib');
ModLib::__hx__init();
