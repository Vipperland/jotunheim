<?php
/**
 * Generated by Haxe 4.3.0
 */

namespace jotun\net;

use \jotun\serial\Packager;
use \jotun\gaming\dataform\Pulsar;
use \php\_Boot\HxAnon;
use \jotun\serial\JsonTool;
use \php\Boot;
use \php\Lib;
use \jotun\Jotun;
use \jotun\utils\Dice;
use \php\_Boot\HxString;

/**
 * ...
 * @author Rafael Moreira
 */
class Header {
	/**
	 * @var string
	 */
	static public $HTML = "text/html;charset=utf-8";
	/**
	 * @var string
	 */
	static public $JSON = "application/json;charset=utf-8";
	/**
	 * @var string
	 */
	static public $JSONP = "application/javascript;charset=utf-8";
	/**
	 * @var string
	 */
	static public $TEXT = "text/plain;charset=utf-8";
	/**
	 * @var mixed
	 */
	static public $_client_headers;
	/**
	 * @var bool
	 */
	static public $hasType = false;

	/**
	 * @return void
	 */
	public function __construct () {
	}

	/**
	 * @param string $data
	 * @param int $chunk
	 * 
	 * @return string
	 */
	public function _createPieces ($data, $chunk) {
		#src/jotun/net/Header.hx:95: characters 3-17
		$f = 0;
		#src/jotun/net/Header.hx:96: characters 3-27
		$t = mb_strlen($data);
		#src/jotun/net/Header.hx:97: characters 3-24
		$copy = "";
		#src/jotun/net/Header.hx:98: lines 98-104
		while ($f < $t) {
			#src/jotun/net/Header.hx:99: characters 4-33
			$copy = ($copy??'null') . (\mb_substr($data, $f, $chunk)??'null');
			#src/jotun/net/Header.hx:100: characters 4-14
			$f += $chunk;
			#src/jotun/net/Header.hx:101: lines 101-103
			if ($f < $t) {
				#src/jotun/net/Header.hx:102: characters 5-17
				$copy = ($copy??'null') . "\x0A";
			}
		}
		#src/jotun/net/Header.hx:105: characters 3-14
		return $copy;
	}

	/**
	 * @param string $origin
	 * @param string $methods
	 * @param string $headers
	 * @param bool $credentials
	 * 
	 * @return void
	 */
	public function access ($origin = "*", $methods = "POST, GET, DELETE, PUT, PATCH, OPTIONS", $headers = "Origin,Content-Type,Accept,Authorization,X-Request-With", $credentials = true) {
		#src/jotun/net/Header.hx:47: lines 47-52
		if ($origin === null) {
			$origin = "*";
		}
		if ($methods === null) {
			$methods = "POST, GET, DELETE, PUT, PATCH, OPTIONS";
		}
		if ($headers === null) {
			$headers = "Origin,Content-Type,Accept,Authorization,X-Request-With";
		}
		if ($credentials === null) {
			$credentials = true;
		}
		#src/jotun/net/Header.hx:48: characters 3-55
		\header("Access-Control-Allow-Origin" . ": " . ($origin??'null'));
		#src/jotun/net/Header.hx:49: characters 3-57
		\header("Access-Control-Allow-Methods" . ": " . ($methods??'null'));
		#src/jotun/net/Header.hx:50: characters 3-57
		\header("Access-Control-Allow-Headers" . ": " . ($headers??'null'));
		#src/jotun/net/Header.hx:51: characters 3-77
		\header("Access-Control-Allow-Credentials" . ": " . \Std::string($credentials));
	}

	/**
	 * @param string $type
	 * 
	 * @return void
	 */
	public function content ($type) {
		#src/jotun/net/Header.hx:55: lines 55-58
		if (!Header::$hasType) {
			#src/jotun/net/Header.hx:56: characters 4-18
			Header::$hasType = true;
			#src/jotun/net/Header.hx:57: characters 4-39
			\header("content-type" . ": " . ($type??'null'));
		}
	}

	/**
	 * @param string $name
	 * 
	 * @return string
	 */
	public function getClientHeader ($name) {
		#src/jotun/net/Header.hx:149: characters 3-63
		return \Reflect::field($this->getClientHeaders(), \mb_strtoupper($name));
	}

	/**
	 * @return mixed
	 */
	public function getClientHeaders () {
		#src/jotun/net/Header.hx:153: lines 153-165
		if (Header::$_client_headers === null) {
			#src/jotun/net/Header.hx:154: characters 4-19
			Header::$_client_headers = new HxAnon();
			#src/jotun/net/Header.hx:155: characters 4-73
			$h = Lib::hashOfAssociativeArray($_SERVER);
			#src/jotun/net/Header.hx:156: characters 14-22
			$data = \array_values(\array_map("strval", \array_keys($h->data)));
			$_g_current = 0;
			$_g_length = \count($data);
			$_g_data = $data;
			#src/jotun/net/Header.hx:156: lines 156-164
			while ($_g_current < $_g_length) {
				$k = $_g_data[$_g_current++];
				#src/jotun/net/Header.hx:157: characters 5-37
				$sk = \mb_strtoupper($k);
				#src/jotun/net/Header.hx:158: lines 158-163
				if (\mb_substr($sk, 0, 5) === "HTTP_") {
					#src/jotun/net/Header.hx:159: characters 6-63
					\Reflect::setField(Header::$_client_headers, \mb_substr($sk, 5, null), ($h->data[$k] ?? null));
				} else if ((\mb_substr($sk, 0, 8) === "CONTENT_") || (\mb_substr($sk, 0, 4) === "AUTH")) {
					#src/jotun/net/Header.hx:162: characters 6-53
					\Reflect::setField(Header::$_client_headers, $sk, ($h->data[$k] ?? null));
				}
			}
		}
		#src/jotun/net/Header.hx:166: characters 3-25
		return Header::$_client_headers;
	}

	/**
	 * @return string
	 */
	public function getOAuth () {
		#src/jotun/net/Header.hx:145: characters 3-42
		return $this->getClientHeader("Authorization");
	}

	/**
	 * @param mixed $origin
	 * 
	 * @return bool
	 */
	public function isOrigin ($origin) {
		#src/jotun/net/Header.hx:37: characters 3-62
		$c = \mb_strtolower(Jotun::$domain->data->HTTP_ORIGIN);
		#src/jotun/net/Header.hx:38: lines 38-44
		if (($origin instanceof \Array_hx)) {
			#src/jotun/net/Header.hx:39: lines 39-41
			return !Dice::Values($origin, function ($v) use (&$c) {
				#src/jotun/net/Header.hx:40: characters 5-30
				return HxString::indexOf($c, $v) !== -1;
			})->completed;
		} else {
			#src/jotun/net/Header.hx:43: characters 4-34
			return HxString::indexOf($c, $origin) !== -1;
		}
	}

	/**
	 * @param string $method
	 * 
	 * @return bool
	 */
	public function isRequestMethod ($method) {
		#src/jotun/net/Header.hx:33: characters 3-80
		return \mb_strtoupper(Jotun::$domain->data->REQUEST_METHOD) === \mb_strtoupper($method);
	}

	/**
	 * @param mixed $data
	 * 
	 * @return void
	 */
	public function setHTML ($data = null) {
		#src/jotun/net/Header.hx:62: characters 3-16
		$this->content(Header::$HTML);
		#src/jotun/net/Header.hx:63: lines 63-66
		if ($data !== null) {
			#src/jotun/net/Header.hx:64: characters 4-60
			\header("Content-Length" . ": " . \Std::string(Boot::dynamicField($data, 'length')));
			#src/jotun/net/Header.hx:65: characters 4-19
			echo(\Std::string($data));
		}
	}

	/**
	 * @param mixed $data
	 * @param bool $encode
	 * @param int $chunk
	 * 
	 * @return void
	 */
	public function setJSON ($data = null, $encode = null, $chunk = null) {
		#src/jotun/net/Header.hx:70: characters 3-16
		$this->content(Header::$JSON);
		#src/jotun/net/Header.hx:71: lines 71-74
		if ($data !== null) {
			#src/jotun/net/Header.hx:72: characters 4-47
			$data = JsonTool::stringify($data, null, "\x09");
			#src/jotun/net/Header.hx:73: characters 4-34
			$this->writeData($data, $encode, $chunk);
		}
	}

	/**
	 * @param string $token
	 * 
	 * @return void
	 */
	public function setOAuth ($token) {
		#src/jotun/net/Header.hx:141: characters 3-40
		\header("Authorization" . ": " . ($token??'null'));
	}

	/**
	 * @param Pulsar $data
	 * @param bool $encode
	 * @param int $chunk
	 * 
	 * @return void
	 */
	public function setPulsar ($data = null, $encode = null, $chunk = null) {
		#src/jotun/net/Header.hx:88: characters 3-16
		$this->content(Header::$TEXT);
		#src/jotun/net/Header.hx:89: lines 89-91
		if ($data !== null) {
			#src/jotun/net/Header.hx:90: characters 4-51
			$this->writeData($data->toString($encode), $encode, $chunk);
		}
	}

	/**
	 * @param mixed $data
	 * @param bool $encode
	 * @param int $chunk
	 * 
	 * @return void
	 */
	public function setTEXT ($data = null, $encode = null, $chunk = null) {
		#src/jotun/net/Header.hx:78: characters 3-16
		$this->content(Header::$TEXT);
		#src/jotun/net/Header.hx:79: lines 79-84
		if ($data !== null) {
			#src/jotun/net/Header.hx:80: lines 80-82
			if (($data instanceof \Array_hx)) {
				#src/jotun/net/Header.hx:81: characters 5-27
				$data = $data->join("\x0A");
			}
			#src/jotun/net/Header.hx:83: characters 4-34
			$this->writeData($data, $encode, $chunk);
		}
	}

	/**
	 * @param string $value
	 * 
	 * @return void
	 */
	public function setURI ($value) {
		#src/jotun/net/Header.hx:137: characters 3-35
		\header("location" . ": " . ($value??'null'));
	}

	/**
	 * @param string $data
	 * @param bool $encode
	 * @param int $chunk
	 * 
	 * @return void
	 */
	public function writeData ($data, $encode = null, $chunk = null) {
		#src/jotun/net/Header.hx:109: lines 109-133
		if ($data !== null) {
			#src/jotun/net/Header.hx:110: lines 110-116
			if ($encode === true) {
				#src/jotun/net/Header.hx:111: characters 5-39
				$data = Packager::encodeBase64($data);
				#src/jotun/net/Header.hx:112: lines 112-115
				if (($chunk !== null) && ($chunk >= 40)) {
					#src/jotun/net/Header.hx:113: characters 6-48
					\header("Content-Chunk" . ": " . ("" . ($chunk??'null')));
					#src/jotun/net/Header.hx:114: characters 6-39
					$data = $this->_createPieces($data, $chunk);
				}
			}
			#src/jotun/net/Header.hx:117: characters 4-61
			$compress = Boot::dynamicField($this->getClientHeaders(), 'ACCEPT_ENCODING');
			#src/jotun/net/Header.hx:118: lines 118-124
			if (HxString::indexOf($compress, "x-gzip") !== -1) {
				#src/jotun/net/Header.hx:119: characters 5-24
				$compress = "x-gzip";
			} else if (HxString::indexOf($compress, "gzip") !== -1) {
				#src/jotun/net/Header.hx:121: characters 5-22
				$compress = "gzip";
			} else {
				#src/jotun/net/Header.hx:123: characters 5-20
				$compress = null;
			}
			#src/jotun/net/Header.hx:125: lines 125-128
			if ($compress !== null) {
				#src/jotun/net/Header.hx:126: characters 5-64
				$data = gzcompress($data,1);
				#src/jotun/net/Header.hx:127: characters 5-48
				\header("Content-Encoding" . ": " . ($compress??'null'));
			}
			#src/jotun/net/Header.hx:129: lines 129-131
			if ($compress !== null) {
				#src/jotun/net/Header.hx:130: characters 5-94
				$data = "\x1F" . \Std::string(chr(139)) . "\x08\x00\x00\x00\x00\x00" . ($data??'null');
			}
			#src/jotun/net/Header.hx:132: characters 4-19
			echo(\Std::string($data));
		}
	}
}

Boot::registerClass(Header::class, 'jotun.net.Header');
