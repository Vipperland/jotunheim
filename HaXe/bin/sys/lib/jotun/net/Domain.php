<?php
/**
 * Generated by Haxe 4.3.6
 */

namespace jotun\net;

use \haxe\io\_BytesData\Container;
use \php\_Boot\HxAnon;
use \jotun\gaming\dataform\Pulsar;
use \php\Boot;
use \haxe\Exception;
use \php\Lib;
use \jotun\Jotun;
use \jotun\utils\Dice;
use \haxe\Json;
use \php\_Boot\HxString;
use \haxe\io\Bytes;

/**
 * ...
 * @author Rafael Moreira <vipperland@live.com,rafael@gateofsirius.com>
 */
class Domain implements IDomain {
	/**
	 * @var string
	 */
	public $client;
	/**
	 * @var string
	 */
	public $domain;
	/**
	 * @var string
	 */
	public $file;
	/**
	 * @var string
	 */
	public $host;
	/**
	 * @var DataSource
	 */
	public $input;
	/**
	 * @var string
	 */
	public $port;
	/**
	 * @var Pulsar
	 */
	public $pulsar;
	/**
	 * @var IDomainData
	 */
	public $server;
	/**
	 * @var string[]|\Array_hx
	 */
	public $url;

	/**
	 * @return void
	 */
	public function __construct () {
		#src/jotun/net/Domain.hx:56: characters 3-14
		$this->_parseURI();
	}

	/**
	 * @return mixed
	 */
	public function _getJsonInput () {
		#src/jotun/net/Domain.hx:132: characters 4-33
		$data = $this->getInput();
		#src/jotun/net/Domain.hx:133: lines 133-135
		if (($data !== null) && (\mb_substr($data, 0, 4) === "----")) {
			#src/jotun/net/Domain.hx:134: characters 5-16
			return null;
		}
		#src/jotun/net/Domain.hx:136: characters 11-49
		if ($data !== null) {
			#src/jotun/net/Domain.hx:136: characters 26-42
			return Json::phpJsonDecode($data);
		} else {
			#src/jotun/net/Domain.hx:136: characters 45-49
			return null;
		}
	}

	/**
	 * @return string
	 */
	public function _getMultipartKey () {
		#src/jotun/net/Domain.hx:201: lines 201-208
		if ($this->isRequestMethod("POST")) {
			#src/jotun/net/Domain.hx:202: characters 5-54
			$a = $_POST;
			#src/jotun/net/Domain.hx:203: characters 5-46
			$post = Lib::hashOfAssociativeArray($a);
			#src/jotun/net/Domain.hx:204: characters 17-28
			$data = \array_values(\array_map("strval", \array_keys($post->data)));
			$_g_current = 0;
			$_g_length = \count($data);
			$_g_data = $data;
			#src/jotun/net/Domain.hx:204: lines 204-207
			while ($_g_current < $_g_length) {
				$key = $_g_data[$_g_current++];
				#src/jotun/net/Domain.hx:205: lines 205-206
				if (HxString::indexOf($key, "Content-Disposition:_form-data;_name") !== -1) {
					#src/jotun/net/Domain.hx:206: characters 7-17
					return $key;
				}
			}
		}
		#src/jotun/net/Domain.hx:209: characters 4-15
		return null;
	}

	/**
	 * Merge POST and GET parameters as one string vector
	 * @return
	 * 
	 * @return mixed
	 */
	public function _getParams () {
		#src/jotun/net/Domain.hx:144: characters 4-73
		$a = array_merge($_GET, $_POST);
		#src/jotun/net/Domain.hx:157: characters 5-43
		return Lib::objectOfAssociativeArray($a);
	}

	/**
	 * Parse Multipart/FormData raw data (properties only)
	 * @param	boundary
	 * @param	data
	 * @return
	 * 
	 * @param string $boundary
	 * @param mixed $data
	 * 
	 * @return mixed
	 */
	public function _getRawData ($boundary, $data = null) {
		#src/jotun/net/Domain.hx:168: lines 168-170
		if ($data === null) {
			#src/jotun/net/Domain.hx:169: characters 5-14
			$data = new HxAnon();
		}
		#src/jotun/net/Domain.hx:171: characters 4-78
		$content = file_get_contents('php://input');
		#src/jotun/net/Domain.hx:172: characters 4-55
		$result = HxString::split($content, $boundary);
		#src/jotun/net/Domain.hx:173: lines 173-194
		Dice::Values($result, function ($v) use (&$data) {
			#src/jotun/net/Domain.hx:174: lines 174-176
			if (($v === null) || (mb_strlen($v) === 0)) {
				#src/jotun/net/Domain.hx:175: characters 6-12
				return;
			}
			#src/jotun/net/Domain.hx:177: lines 177-193
			if (HxString::indexOf($v, "Content-Disposition: form-data;") < 30) {
				#src/jotun/net/Domain.hx:178: characters 6-102
				$point = HxString::split((HxString::split($v, "Content-Disposition: form-data; name=")->arr[1] ?? null), "\x0D\x0A\x0D\x0A");
				#src/jotun/net/Domain.hx:179: characters 6-55
				$param = HxString::split(($point->arr[0] ?? null), "\"")->join("");
				#src/jotun/net/Domain.hx:180: lines 180-192
				if (HxString::indexOf($param, "Content-Type:") === -1) {
					#src/jotun/net/Domain.hx:181: characters 7-52
					$value = (HxString::split(($point->arr[1] ?? null), "\x0D\x0A")->arr[0] ?? null);
					#src/jotun/net/Domain.hx:182: lines 182-191
					if ((mb_strlen($param) > 0) && (mb_strlen($value) > 0) && ($value !== "null")) {
						#src/jotun/net/Domain.hx:183: lines 183-190
						if (HxString::indexOf($param, "[]") === -1) {
							#src/jotun/net/Domain.hx:184: characters 9-45
							\Reflect::setField($data, $param, $value);
						} else {
							#src/jotun/net/Domain.hx:186: lines 186-188
							if (!\Reflect::hasField($data, $param)) {
								#src/jotun/net/Domain.hx:187: characters 10-43
								\Reflect::setField($data, $param, new \Array_hx());
							}
							#src/jotun/net/Domain.hx:189: characters 9-47
							\Reflect::field($data, $param)->push($value);
						}
					}
				}
			}
		});
		#src/jotun/net/Domain.hx:196: characters 4-15
		return $data;
	}

	/**
	 * @return void
	 */
	public function _parseURI () {
		#src/jotun/net/Domain.hx:72: characters 4-76
		$this->server = Lib::objectOfAssociativeArray($_SERVER);
		#src/jotun/net/Domain.hx:73: characters 4-29
		$this->port = $this->server->SERVER_PORT;
		#src/jotun/net/Domain.hx:74: characters 4-25
		$this->domain = (\dirname($_SERVER["SCRIPT_FILENAME"])??'null') . "/";
		#src/jotun/net/Domain.hx:75: characters 4-28
		$this->host = $_SERVER["SERVER_NAME"];
		#src/jotun/net/Domain.hx:76: characters 4-30
		$this->client = $_SERVER["REMOTE_ADDR"];
		#src/jotun/net/Domain.hx:78: characters 4-45
		$boundary = $this->_getMultipartKey();
		#src/jotun/net/Domain.hx:80: characters 12-31
		$__hx__switch = ($this->server->CONTENT_TYPE);
		if ($__hx__switch === "application/json") {
			#src/jotun/net/Domain.hx:82: characters 6-45
			$this->input = new DataSource($this->_getJsonInput());
		} else if ($__hx__switch === "plain/pulsar") {
			#src/jotun/net/Domain.hx:85: characters 6-40
			$this->pulsar = Pulsar::create($this->getInput());
		}
		#src/jotun/net/Domain.hx:89: characters 4-47
		Jotun::$params = new DataSource($this->_getParams());
		#src/jotun/net/Domain.hx:91: lines 91-95
		if ($boundary !== null) {
			#src/jotun/net/Domain.hx:92: characters 5-53
			\Reflect::deleteField(Jotun::$params->data, $boundary);
			#src/jotun/net/Domain.hx:93: characters 5-41
			$boundary = (HxString::split($boundary, "\x0D\x0A")->arr[0] ?? null);
			#src/jotun/net/Domain.hx:94: characters 5-45
			$this->_getRawData($boundary, Jotun::$params->data);
		}
		#src/jotun/net/Domain.hx:96: characters 4-39
		$this->url = HxString::split($this->server->SCRIPT_NAME, "/");
	}

	/**
	 * @param int $len
	 * 
	 * @return string
	 */
	public function getDomain ($len = 2) {
		#src/jotun/net/Domain.hx:102: lines 102-105
		if ($len === null) {
			$len = 2;
		}
		#src/jotun/net/Domain.hx:103: characters 3-41
		$h = HxString::split($this->host, ".");
		#src/jotun/net/Domain.hx:104: characters 3-49
		return $h->splice($h->length - $len, $len)->join(".");
	}

	/**
	 * @return string
	 */
	public function getInput () {
		#src/jotun/net/Domain.hx:251: characters 4-75
		$data = file_get_contents('php://input');
		#src/jotun/net/Domain.hx:252: characters 11-56
		if (($data !== null) && (mb_strlen($data) > 0)) {
			#src/jotun/net/Domain.hx:252: characters 45-49
			return $data;
		} else {
			#src/jotun/net/Domain.hx:252: characters 52-56
			return null;
		}
	}

	/**
	 * @return string
	 */
	public function getRequestMethod () {
		#src/jotun/net/Domain.hx:124: characters 11-46
		return \mb_strtoupper($this->server->REQUEST_METHOD);
	}

	/**
	 * @param string $q
	 * 
	 * @return bool
	 */
	public function isRequestMethod ($q) {
		#src/jotun/net/Domain.hx:128: characters 4-48
		return $this->getRequestMethod() === \mb_strtoupper($q);
	}

	/**
	 * @param \Closure $onPart
	 * @param \Closure $onData
	 * 
	 * @return void
	 */
	public function parseFiles ($onPart, $onData) {
		#src/jotun/net/Domain.hx:213: characters 4-52
		$files = $_FILES;
		#src/jotun/net/Domain.hx:214: lines 214-216
		if (!isset($files)) {
			#src/jotun/net/Domain.hx:215: characters 5-11
			return;
		}
		#src/jotun/net/Domain.hx:217: characters 4-66
		$keys = array_keys($files);
		#src/jotun/net/Domain.hx:218: characters 4-54
		$parts = \Array_hx::wrap($keys);
		#src/jotun/net/Domain.hx:219: lines 219-246
		$_g = 0;
		while ($_g < $parts->length) {
			#src/jotun/net/Domain.hx:219: characters 8-12
			$part = ($parts->arr[$_g] ?? null);
			#src/jotun/net/Domain.hx:219: lines 219-246
			++$_g;
			#src/jotun/net/Domain.hx:220: characters 5-61
			$info = $_FILES[$part];
			#src/jotun/net/Domain.hx:221: characters 5-49
			$tmp = $info["tmp_name"];
			#src/jotun/net/Domain.hx:222: characters 5-46
			$file = $info["name"];
			#src/jotun/net/Domain.hx:223: characters 5-43
			$err = $info["error"];
			#src/jotun/net/Domain.hx:224: lines 224-234
			if ($err > 0) {
				#src/jotun/net/Domain.hx:225: lines 225-233
				if ($err === 1) {
					#src/jotun/net/Domain.hx:226: characters 15-20
					throw Exception::thrown("The uploaded file exceeds the max size of " . \Std::string(ini_get("upload_max_filesize")));
				} else if ($err === 2) {
					#src/jotun/net/Domain.hx:227: characters 15-20
					throw Exception::thrown("The uploaded file exceeds the max file size directive specified in the HTML form (max is" . \Std::string(ini_get("post_max_size")) . ")");
				} else if ($err === 3) {
					#src/jotun/net/Domain.hx:228: characters 15-20
					throw Exception::thrown("The uploaded file was only partially uploaded");
				} else if ($err === 4) {
					#src/jotun/net/Domain.hx:229: characters 15-23
					continue;
				} else if ($err === 6) {
					#src/jotun/net/Domain.hx:230: characters 15-20
					throw Exception::thrown("Missing a temporary folder");
				} else if ($err === 7) {
					#src/jotun/net/Domain.hx:231: characters 15-20
					throw Exception::thrown("Failed to write file to disk");
				} else if ($err === 8) {
					#src/jotun/net/Domain.hx:232: characters 15-20
					throw Exception::thrown("File upload stopped by extension");
				}
			}
			#src/jotun/net/Domain.hx:235: characters 5-23
			$onPart($part, $file);
			#src/jotun/net/Domain.hx:236: lines 236-245
			if ("" !== $file) {
				#src/jotun/net/Domain.hx:237: characters 6-59
				$h = fopen($tmp,"r");
				#src/jotun/net/Domain.hx:238: characters 6-23
				$bsize = 8192;
				#src/jotun/net/Domain.hx:239: lines 239-243
				while (!feof($h)) {
					#src/jotun/net/Domain.hx:240: characters 7-71
					$buf = fread($h,$bsize);
					#src/jotun/net/Domain.hx:241: characters 7-61
					$size = strlen($buf);
					#src/jotun/net/Domain.hx:242: characters 14-33
					$tmp1 = \strlen($buf);
					#src/jotun/net/Domain.hx:242: characters 7-43
					$onData(new Bytes($tmp1, new Container($buf)), 0, $size);
				}
				#src/jotun/net/Domain.hx:244: characters 6-40
				fclose($h);
			}
		}
	}
}

Boot::registerClass(Domain::class, 'jotun.net.Domain');
