<?php
/**
 * Generated by Haxe 4.3.0
 */

namespace jotun\net;

use \haxe\io\_BytesData\Container;
use \php\_Boot\HxAnon;
use \php\Boot;
use \haxe\Exception;
use \php\Lib;
use \jotun\utils\Dice;
use \haxe\Json;
use \php\_Boot\HxString;
use \haxe\io\Bytes;

/**
 * ...
 * @author Rafael Moreira <vipperland@live.com,rafael@gateofsirius.com>
 */
class Domain implements IDomain {
	/**
	 * @var string
	 */
	public $client;
	/**
	 * @var IDomainData
	 */
	public $data;
	/**
	 * @var string
	 */
	public $file;
	/**
	 * @var string
	 */
	public $host;
	/**
	 * @var mixed
	 */
	public $input;
	/**
	 * @var mixed
	 */
	public $params;
	/**
	 * @var string
	 */
	public $port;
	/**
	 * @var string
	 */
	public $server;
	/**
	 * @var string[]|\Array_hx
	 */
	public $url;

	/**
	 * @return void
	 */
	public function __construct () {
		#src/jotun/net/Domain.hx:54: characters 3-14
		$this->_parseURI();
	}

	/**
	 * @return mixed
	 */
	public function _getJsonInput () {
		#src/jotun/net/Domain.hx:133: characters 4-33
		$data = $this->getInput();
		#src/jotun/net/Domain.hx:134: characters 11-49
		if ($data !== null) {
			#src/jotun/net/Domain.hx:134: characters 26-42
			return Json::phpJsonDecode($data);
		} else {
			#src/jotun/net/Domain.hx:134: characters 45-49
			return null;
		}
	}

	/**
	 * @return string
	 */
	public function _getMultipartKey () {
		#src/jotun/net/Domain.hx:202: lines 202-212
		if ($this->isRequestMethod("POST")) {
			#src/jotun/net/Domain.hx:203: characters 5-54
			$a = $_POST;
			#src/jotun/net/Domain.hx:204: lines 204-206
			if (get_magic_quotes_gpc()) {
				#src/jotun/net/Domain.hx:205: characters 6-101
				reset($a); while(list($k, $v) = each($a)) $a[$k] = stripslashes((string)$v);
			}
			#src/jotun/net/Domain.hx:207: characters 5-46
			$post = Lib::hashOfAssociativeArray($a);
			#src/jotun/net/Domain.hx:208: characters 17-28
			$data = \array_values(\array_map("strval", \array_keys($post->data)));
			$_g_current = 0;
			$_g_length = \count($data);
			$_g_data = $data;
			#src/jotun/net/Domain.hx:208: lines 208-211
			while ($_g_current < $_g_length) {
				$key = $_g_data[$_g_current++];
				#src/jotun/net/Domain.hx:209: lines 209-210
				if (HxString::indexOf($key, "Content-Disposition:_form-data;_name") !== -1) {
					#src/jotun/net/Domain.hx:210: characters 7-17
					return $key;
				}
			}
		}
		#src/jotun/net/Domain.hx:213: characters 4-15
		return null;
	}

	/**
	 * Merge POST and GET parameters as one string vector
	 * @return
	 * 
	 * @return mixed
	 */
	public function _getParams () {
		#src/jotun/net/Domain.hx:142: characters 4-73
		$a = array_merge($_GET, $_POST);
		#src/jotun/net/Domain.hx:143: lines 143-145
		if (get_magic_quotes_gpc()) {
			#src/jotun/net/Domain.hx:144: characters 5-100
			reset($a); while(list($k, $v) = each($a)) $a[$k] = stripslashes((string)$v);
		}
		#src/jotun/net/Domain.hx:158: characters 5-43
		return Lib::objectOfAssociativeArray($a);
	}

	/**
	 * Parse Multipart/FormData raw data (properties only)
	 * @param	boundary
	 * @param	data
	 * @return
	 * 
	 * @param string $boundary
	 * @param mixed $data
	 * 
	 * @return mixed
	 */
	public function _getRawData ($boundary, $data = null) {
		#src/jotun/net/Domain.hx:169: lines 169-171
		if ($data === null) {
			#src/jotun/net/Domain.hx:170: characters 5-14
			$data = new HxAnon();
		}
		#src/jotun/net/Domain.hx:172: characters 4-78
		$content = file_get_contents('php://input');
		#src/jotun/net/Domain.hx:173: characters 4-55
		$result = HxString::split($content, $boundary);
		#src/jotun/net/Domain.hx:174: lines 174-195
		Dice::Values($result, function ($v) use (&$data) {
			#src/jotun/net/Domain.hx:175: lines 175-177
			if (($v === null) || (mb_strlen($v) === 0)) {
				#src/jotun/net/Domain.hx:176: characters 6-12
				return;
			}
			#src/jotun/net/Domain.hx:178: lines 178-194
			if (HxString::indexOf($v, "Content-Disposition: form-data;") < 30) {
				#src/jotun/net/Domain.hx:179: characters 6-102
				$point = HxString::split((HxString::split($v, "Content-Disposition: form-data; name=")->arr[1] ?? null), "\x0D\x0A\x0D\x0A");
				#src/jotun/net/Domain.hx:180: characters 6-55
				$param = HxString::split(($point->arr[0] ?? null), "\"")->join("");
				#src/jotun/net/Domain.hx:181: lines 181-193
				if (HxString::indexOf($param, "Content-Type:") === -1) {
					#src/jotun/net/Domain.hx:182: characters 7-52
					$value = (HxString::split(($point->arr[1] ?? null), "\x0D\x0A")->arr[0] ?? null);
					#src/jotun/net/Domain.hx:183: lines 183-192
					if ((mb_strlen($param) > 0) && (mb_strlen($value) > 0) && ($value !== "null")) {
						#src/jotun/net/Domain.hx:184: lines 184-191
						if (HxString::indexOf($param, "[]") === -1) {
							#src/jotun/net/Domain.hx:185: characters 9-45
							\Reflect::setField($data, $param, $value);
						} else {
							#src/jotun/net/Domain.hx:187: lines 187-189
							if (!\Reflect::hasField($data, $param)) {
								#src/jotun/net/Domain.hx:188: characters 10-43
								\Reflect::setField($data, $param, new \Array_hx());
							}
							#src/jotun/net/Domain.hx:190: characters 9-47
							\Reflect::field($data, $param)->push($value);
						}
					}
				}
			}
		});
		#src/jotun/net/Domain.hx:197: characters 4-15
		return $data;
	}

	/**
	 * @return void
	 */
	public function _parseURI () {
		#src/jotun/net/Domain.hx:70: characters 4-74
		$this->data = Lib::objectOfAssociativeArray($_SERVER);
		#src/jotun/net/Domain.hx:71: characters 4-27
		$this->port = $this->data->SERVER_PORT;
		#src/jotun/net/Domain.hx:72: characters 4-25
		$this->server = (\dirname($_SERVER["SCRIPT_FILENAME"])??'null') . "/";
		#src/jotun/net/Domain.hx:73: characters 4-28
		$this->host = $_SERVER["SERVER_NAME"];
		#src/jotun/net/Domain.hx:74: characters 4-30
		$this->client = $_SERVER["REMOTE_ADDR"];
		#src/jotun/net/Domain.hx:76: characters 4-45
		$boundary = $this->_getMultipartKey();
		#src/jotun/net/Domain.hx:78: lines 78-80
		if ($this->data->CONTENT_TYPE === "application/json") {
			#src/jotun/net/Domain.hx:79: characters 5-28
			$this->input = $this->_getJsonInput();
		}
		#src/jotun/net/Domain.hx:81: characters 4-25
		$this->params = $this->_getParams();
		#src/jotun/net/Domain.hx:83: lines 83-87
		if ($boundary !== null) {
			#src/jotun/net/Domain.hx:84: characters 5-42
			\Reflect::deleteField($this->params, $boundary);
			#src/jotun/net/Domain.hx:85: characters 5-41
			$boundary = (HxString::split($boundary, "\x0D\x0A")->arr[0] ?? null);
			#src/jotun/net/Domain.hx:86: characters 5-34
			$this->_getRawData($boundary, $this->params);
		}
		#src/jotun/net/Domain.hx:88: characters 4-37
		$this->url = HxString::split($this->data->SCRIPT_NAME, "/");
	}

	/**
	 * @param int $len
	 * 
	 * @return string
	 */
	public function getFQDN ($len = 2) {
		#src/jotun/net/Domain.hx:94: lines 94-97
		if ($len === null) {
			$len = 2;
		}
		#src/jotun/net/Domain.hx:95: characters 3-41
		$h = HxString::split($this->host, ".");
		#src/jotun/net/Domain.hx:96: characters 3-49
		return $h->splice($h->length - $len, $len)->join(".");
	}

	/**
	 * @return string
	 */
	public function getInput () {
		#src/jotun/net/Domain.hx:255: characters 4-75
		$data = file_get_contents('php://input');
		#src/jotun/net/Domain.hx:256: characters 11-56
		if (($data !== null) && (mb_strlen($data) > 0)) {
			#src/jotun/net/Domain.hx:256: characters 45-49
			return $data;
		} else {
			#src/jotun/net/Domain.hx:256: characters 52-56
			return null;
		}
	}

	/**
	 * @return string
	 */
	public function getRequestMethod () {
		#src/jotun/net/Domain.hx:116: characters 11-44
		return \mb_strtoupper($this->data->REQUEST_METHOD);
	}

	/**
	 * @param string $q
	 * 
	 * @return bool
	 */
	public function isRequestMethod ($q) {
		#src/jotun/net/Domain.hx:120: characters 4-48
		return $this->getRequestMethod() === \mb_strtoupper($q);
	}

	/**
	 * @param \Closure $onPart
	 * @param \Closure $onData
	 * 
	 * @return void
	 */
	public function parseFiles ($onPart, $onData) {
		#src/jotun/net/Domain.hx:217: characters 4-52
		$files = $_FILES;
		#src/jotun/net/Domain.hx:218: lines 218-220
		if (!isset($files)) {
			#src/jotun/net/Domain.hx:219: characters 5-11
			return;
		}
		#src/jotun/net/Domain.hx:221: characters 4-66
		$keys = array_keys($files);
		#src/jotun/net/Domain.hx:222: characters 4-54
		$parts = \Array_hx::wrap($keys);
		#src/jotun/net/Domain.hx:223: lines 223-250
		$_g = 0;
		while ($_g < $parts->length) {
			#src/jotun/net/Domain.hx:223: characters 8-12
			$part = ($parts->arr[$_g] ?? null);
			#src/jotun/net/Domain.hx:223: lines 223-250
			++$_g;
			#src/jotun/net/Domain.hx:224: characters 5-61
			$info = $_FILES[$part];
			#src/jotun/net/Domain.hx:225: characters 5-49
			$tmp = $info["tmp_name"];
			#src/jotun/net/Domain.hx:226: characters 5-46
			$file = $info["name"];
			#src/jotun/net/Domain.hx:227: characters 5-43
			$err = $info["error"];
			#src/jotun/net/Domain.hx:228: lines 228-238
			if ($err > 0) {
				#src/jotun/net/Domain.hx:229: lines 229-237
				if ($err === 1) {
					#src/jotun/net/Domain.hx:230: characters 15-20
					throw Exception::thrown("The uploaded file exceeds the max size of " . \Std::string(ini_get("upload_max_filesize")));
				} else if ($err === 2) {
					#src/jotun/net/Domain.hx:231: characters 15-20
					throw Exception::thrown("The uploaded file exceeds the max file size directive specified in the HTML form (max is" . \Std::string(ini_get("post_max_size")) . ")");
				} else if ($err === 3) {
					#src/jotun/net/Domain.hx:232: characters 15-20
					throw Exception::thrown("The uploaded file was only partially uploaded");
				} else if ($err === 4) {
					#src/jotun/net/Domain.hx:233: characters 15-23
					continue;
				} else if ($err === 6) {
					#src/jotun/net/Domain.hx:234: characters 15-20
					throw Exception::thrown("Missing a temporary folder");
				} else if ($err === 7) {
					#src/jotun/net/Domain.hx:235: characters 15-20
					throw Exception::thrown("Failed to write file to disk");
				} else if ($err === 8) {
					#src/jotun/net/Domain.hx:236: characters 15-20
					throw Exception::thrown("File upload stopped by extension");
				}
			}
			#src/jotun/net/Domain.hx:239: characters 5-23
			$onPart($part, $file);
			#src/jotun/net/Domain.hx:240: lines 240-249
			if ("" !== $file) {
				#src/jotun/net/Domain.hx:241: characters 6-59
				$h = fopen($tmp,"r");
				#src/jotun/net/Domain.hx:242: characters 6-23
				$bsize = 8192;
				#src/jotun/net/Domain.hx:243: lines 243-247
				while (!feof($h)) {
					#src/jotun/net/Domain.hx:244: characters 7-71
					$buf = fread($h,$bsize);
					#src/jotun/net/Domain.hx:245: characters 7-61
					$size = strlen($buf);
					#src/jotun/net/Domain.hx:246: characters 14-33
					$tmp1 = \strlen($buf);
					#src/jotun/net/Domain.hx:246: characters 7-43
					$onData(new Bytes($tmp1, new Container($buf)), 0, $size);
				}
				#src/jotun/net/Domain.hx:248: characters 6-40
				fclose($h);
			}
		}
	}

	/**
	 * @param string[]|\Array_hx $params
	 * 
	 * @return bool
	 */
	public function require ($params) {
		#src/jotun/net/Domain.hx:123: lines 123-130
		$_gthis = $this;
		#src/jotun/net/Domain.hx:124: characters 4-22
		$r = true;
		#src/jotun/net/Domain.hx:125: lines 125-128
		Dice::Values($params, function ($v) use (&$r, &$_gthis) {
			#src/jotun/net/Domain.hx:126: characters 5-41
			$r = \Reflect::hasField($_gthis->params, $v);
			#src/jotun/net/Domain.hx:127: characters 5-14
			return !$r;
		});
		#src/jotun/net/Domain.hx:129: characters 4-12
		return $r;
	}
}

Boot::registerClass(Domain::class, 'jotun.net.Domain');
