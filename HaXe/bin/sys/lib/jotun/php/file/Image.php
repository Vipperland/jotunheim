<?php
/**
 * Generated by Haxe 4.3.0
 */

namespace jotun\php\file;

use \php\Boot;

/**
 * ...
 * @author Rafael Moreira <rafael@gateofsirius.com>
 */
class Image implements IImage {
	/**
	 * @var mixed
	 * Image file
	 */
	public $_res;
	/**
	 * @var int
	 * Current image height
	 */
	public $height;
	/**
	 * @var string
	 * Current image name
	 */
	public $name;
	/**
	 * @var int
	 * File Type
	 */
	public $type;
	/**
	 * @var int
	 * Current image width
	 */
	public $width;

	/**
	 * Create a image manipulator object
	 * @param	file
	 * 
	 * @param mixed $file
	 * 
	 * @return void
	 */
	public function __construct ($file = null) {
		#src/jotun/php/file/Image.hx:50: lines 50-52
		if ($file !== null) {
			#src/jotun/php/file/Image.hx:51: characters 4-14
			$this->open($file);
		}
	}

	/**
	 * @param mixed $resource
	 * 
	 * @return void
	 */
	public function _update ($resource) {
		#src/jotun/php/file/Image.hx:39: characters 3-12
		$this->dispose();
		#src/jotun/php/file/Image.hx:40: characters 3-18
		$this->_res = $resource;
		#src/jotun/php/file/Image.hx:41: characters 3-53
		$this->width = imagesx($this->_res);
		#src/jotun/php/file/Image.hx:42: characters 3-54
		$this->height = imagesy($this->_res);
	}

	/**
	 * Crop image on coordinates
	 * @param	x
	 * @param	y
	 * @param	width
	 * @param	height
	 * @return
	 * 
	 * @param int $x
	 * @param int $y
	 * @param int $width
	 * @param int $height
	 * 
	 * @return IImage
	 */
	public function crop ($x, $y, $width, $height) {
		#src/jotun/php/file/Image.hx:127: lines 127-151
		if ($this->isValid()) {
			#src/jotun/php/file/Image.hx:129: lines 129-131
			if ($x < 0) {
				#src/jotun/php/file/Image.hx:130: characters 5-10
				$x = 0;
			}
			#src/jotun/php/file/Image.hx:132: lines 132-134
			if ($y < 0) {
				#src/jotun/php/file/Image.hx:133: characters 5-10
				$y = 0;
			}
			#src/jotun/php/file/Image.hx:135: characters 4-27
			$tx = $x + $width;
			#src/jotun/php/file/Image.hx:136: characters 4-27
			$ty = $y + $width;
			#src/jotun/php/file/Image.hx:138: lines 138-140
			if ($tx > $this->width) {
				#src/jotun/php/file/Image.hx:139: characters 5-20
				$tx = $this->width;
			}
			#src/jotun/php/file/Image.hx:141: lines 141-143
			if ($ty > $this->height) {
				#src/jotun/php/file/Image.hx:142: characters 5-21
				$ty = $this->height;
			}
			#src/jotun/php/file/Image.hx:146: characters 4-94
			$newimg = imagecreatetruecolor($width,$height);
			#src/jotun/php/file/Image.hx:147: lines 147-150
			if ($newimg !== null) {
				#src/jotun/php/file/Image.hx:148: characters 5-105
				imagecopy($newimg,$this->_res,$x,$y,0,0,$tx,$ty);
				#src/jotun/php/file/Image.hx:149: characters 5-20
				$this->_update($newimg);
			}
		}
		#src/jotun/php/file/Image.hx:152: characters 9-20
		return $this;
	}

	/**
	 * @return void
	 */
	public function delete () {
		#src/jotun/php/file/Image.hx:208: characters 3-30
		\unlink($this->name);
	}

	/**
	 * @return void
	 */
	public function dispose () {
		#src/jotun/php/file/Image.hx:212: lines 212-214
		if ($this->_res !== null) {
			#src/jotun/php/file/Image.hx:213: characters 4-51
			imagedestroy($this->_res);
		}
		#src/jotun/php/file/Image.hx:215: characters 3-14
		$this->_res = null;
	}

	/**
	 * Ffit image to size
	 * @param	width
	 * @param	height
	 * @return
	 * 
	 * @param int $width
	 * @param int $height
	 * 
	 * @return IImage
	 */
	public function fit ($width, $height) {
		#src/jotun/php/file/Image.hx:162: lines 162-171
		if ($this->isValid()) {
			#src/jotun/php/file/Image.hx:163: characters 4-28
			$ow = $this->width;
			#src/jotun/php/file/Image.hx:164: characters 4-29
			$oh = $this->height;
			#src/jotun/php/file/Image.hx:166: lines 166-170
			if ($ow >= $oh) {
				#src/jotun/php/file/Image.hx:167: characters 5-58
				$this->resample((int)(\floor($width / $ow * $height + 0.5)), $height, true);
			} else {
				#src/jotun/php/file/Image.hx:169: characters 5-57
				$this->resample($width, (int)(\floor($height / $oh * $width + 0.5)), true);
			}
		}
		#src/jotun/php/file/Image.hx:172: characters 3-14
		return $this;
	}

	/**
	 * @param int $width
	 * @param int $height
	 * 
	 * @return bool
	 */
	public function isOutBounds ($width, $height) {
		#src/jotun/php/file/Image.hx:176: characters 3-65
		return (($this->width <= $width) && ($this->height <= $height)) === false;
	}

	/**
	 * Check if resource is valid
	 * @return
	 * 
	 * @return bool
	 */
	public function isValid () {
		#src/jotun/php/file/Image.hx:223: characters 3-22
		return $this->_res !== null;
	}

	/**
	 * Open file for location or data string
	 * @param	file
	 * @return
	 * 
	 * @param mixed $file
	 * 
	 * @return IImage
	 */
	public function open ($file) {
		#src/jotun/php/file/Image.hx:61: characters 3-12
		$this->dispose();
		#src/jotun/php/file/Image.hx:62: lines 62-84
		if ($file !== null) {
			#src/jotun/php/file/Image.hx:64: characters 4-65
			$isFile = is_file($file);
			#src/jotun/php/file/Image.hx:65: characters 4-27
			$img = null;
			#src/jotun/php/file/Image.hx:66: lines 66-82
			if ($isFile) {
				#src/jotun/php/file/Image.hx:67: characters 5-16
				$this->name = $file;
				#src/jotun/php/file/Image.hx:68: characters 5-76
				$info = getimagesize($file);
				#src/jotun/php/file/Image.hx:69: characters 5-20
				$this->width = $info[0];
				#src/jotun/php/file/Image.hx:70: characters 5-21
				$this->height = $info[1];
				#src/jotun/php/file/Image.hx:71: characters 5-19
				$this->type = $info[2];
				#src/jotun/php/file/Image.hx:72: characters 12-16
				$__hx__switch = ($this->type);
				if ($__hx__switch === 1) {
					#src/jotun/php/file/Image.hx:73: characters 15-74
					$img = imagecreatefromgif($file);
				} else if ($__hx__switch === 2) {
					#src/jotun/php/file/Image.hx:74: characters 15-75
					$img = imagecreatefromjpeg($file);
				} else if ($__hx__switch === 3) {
					#src/jotun/php/file/Image.hx:75: characters 15-74
					$img = imagecreatefrompng($file);
				} else if ($__hx__switch === 6) {
					#src/jotun/php/file/Image.hx:76: characters 15-75
					$img = imagecreatefromwbmp($file);
				}
			} else {
				#src/jotun/php/file/Image.hx:79: characters 5-67
				$img = imagecreatefromstring($file);
				#src/jotun/php/file/Image.hx:80: characters 5-55
				$this->width = imagesx($this->_res);
				#src/jotun/php/file/Image.hx:81: characters 5-56
				$this->height = imagesy($this->_res);
			}
			#src/jotun/php/file/Image.hx:83: characters 4-14
			$this->_res = $img;
		}
		#src/jotun/php/file/Image.hx:85: characters 3-14
		return $this;
	}

	/**
	 * Change image size
	 * @param	width
	 * @param	height
	 * @param	ratio
	 * @return
	 * 
	 * @param int $width
	 * @param int $height
	 * @param bool $ratio
	 * 
	 * @return IImage
	 */
	public function resample ($width, $height, $ratio = true) {
		#src/jotun/php/file/Image.hx:95: lines 95-116
		if ($ratio === null) {
			$ratio = true;
		}
		#src/jotun/php/file/Image.hx:96: lines 96-114
		if ($this->isValid()) {
			#src/jotun/php/file/Image.hx:97: lines 97-103
			if ($ratio) {
				#src/jotun/php/file/Image.hx:98: lines 98-102
				if ($height >= $width) {
					#src/jotun/php/file/Image.hx:99: characters 14-59
					$width = (int)(\floor($height / $this->height * $this->width + 0.5));
				} else {
					#src/jotun/php/file/Image.hx:101: characters 15-59
					$height = (int)(\floor($width / $this->width * $this->height + 0.5));
				}
			}
			#src/jotun/php/file/Image.hx:104: characters 4-94
			$newimg = imagecreatetruecolor($width,$height);
			#src/jotun/php/file/Image.hx:106: lines 106-113
			if ($newimg !== null) {
				#src/jotun/php/file/Image.hx:107: characters 5-71
				imagealphablending($newimg,false);
				#src/jotun/php/file/Image.hx:108: characters 5-66
				imagesavealpha($newimg,true);
				#src/jotun/php/file/Image.hx:109: characters 5-122
				$alpha = imagecolorallocatealpha($newimg,255,255,255,127);
				#src/jotun/php/file/Image.hx:110: characters 5-110
				imagefilledrectangle($newimg,0,0,$width,$height,$alpha);
				#src/jotun/php/file/Image.hx:111: characters 5-154
				imagecopyresampled($newimg,$this->_res,0,0,0,0,$width,$height,$this->width,$this->height);
				#src/jotun/php/file/Image.hx:112: characters 5-20
				$this->_update($newimg);
			}
		}
		#src/jotun/php/file/Image.hx:115: characters 3-14
		return $this;
	}

	/**
	 * Save modified file
	 * @param	name
	 * @param	type
	 * @return
	 * 
	 * @param string $name
	 * @param int $type
	 * @param int $qty
	 * 
	 * @return bool
	 */
	public function save ($name = null, $type = null, $qty = null) {
		#src/jotun/php/file/Image.hx:186: lines 186-203
		if ($this->isValid()) {
			#src/jotun/php/file/Image.hx:187: lines 187-189
			if ($type === null) {
				#src/jotun/php/file/Image.hx:188: characters 5-21
				$type = $this->type;
			}
			#src/jotun/php/file/Image.hx:190: lines 190-192
			if ($name === null) {
				#src/jotun/php/file/Image.hx:191: characters 5-21
				$name = $this->name;
			}
			#src/jotun/php/file/Image.hx:193: lines 193-202
			try {
				#src/jotun/php/file/Image.hx:194: lines 194-199
				if ($type === null) {
					#src/jotun/php/file/Image.hx:198: characters 16-98
					imagejpeg($this->_res,$name,($qty !== null ? $qty : 80));
				} else {
					#src/jotun/php/file/Image.hx:194: characters 12-16
					if ($type === 1) {
						#src/jotun/php/file/Image.hx:195: characters 15-68
						imagegif($this->_res,$name);
					} else if ($type === 3) {
						#src/jotun/php/file/Image.hx:196: characters 15-68
						imagepng($this->_res,$name);
					} else if ($type === 6) {
						#src/jotun/php/file/Image.hx:197: characters 15-69
						imagewbmp($this->_res,$name);
					} else {
						#src/jotun/php/file/Image.hx:198: characters 16-98
						imagejpeg($this->_res,$name,($qty !== null ? $qty : 80));
					}
				}
				#src/jotun/php/file/Image.hx:200: characters 5-16
				return true;
			} catch(\Throwable $_g) {
			}
		}
		#src/jotun/php/file/Image.hx:204: characters 3-15
		return false;
	}
}

Boot::registerClass(Image::class, 'jotun.php.file.Image');
