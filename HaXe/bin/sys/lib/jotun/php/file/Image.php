<?php
/**
 * Generated by Haxe 4.3.6
 */

namespace jotun\php\file;

use \php\Boot;

/**
 * ...
 * @author Rafael Moreira <rafael@gateofsirius.com>
 */
class Image implements IImage {
	/**
	 * @var mixed
	 * Image file
	 */
	public $_res;
	/**
	 * @var int
	 * Current image height
	 */
	public $height;
	/**
	 * @var string
	 * Current image name
	 */
	public $name;
	/**
	 * @var int
	 * File Type
	 */
	public $type;
	/**
	 * @var int
	 * Current image width
	 */
	public $width;

	/**
	 * Create a image manipulator object
	 * @param	file
	 * 
	 * @param mixed $file
	 * 
	 * @return void
	 */
	public function __construct ($file = null) {
		#src/jotun/php/file/Image.hx:60: lines 60-62
		if ($file !== null) {
			#src/jotun/php/file/Image.hx:61: characters 4-14
			$this->open($file);
		}
	}

	/**
	 * @param mixed $resource
	 * 
	 * @return void
	 */
	public function _update ($resource) {
		#src/jotun/php/file/Image.hx:49: characters 3-12
		$this->dispose();
		#src/jotun/php/file/Image.hx:50: characters 3-18
		$this->_res = $resource;
		#src/jotun/php/file/Image.hx:51: characters 3-53
		$this->width = imagesx($this->_res);
		#src/jotun/php/file/Image.hx:52: characters 3-54
		$this->height = imagesy($this->_res);
	}

	/**
	 * Crop image on coordinates
	 * @param	x
	 * @param	y
	 * @param	width
	 * @param	height
	 * @return
	 * 
	 * @param int $x
	 * @param int $y
	 * @param int $width
	 * @param int $height
	 * 
	 * @return IImage
	 */
	public function crop ($x, $y, $width, $height) {
		#src/jotun/php/file/Image.hx:137: lines 137-161
		if ($this->isValid()) {
			#src/jotun/php/file/Image.hx:139: lines 139-141
			if ($x < 0) {
				#src/jotun/php/file/Image.hx:140: characters 5-10
				$x = 0;
			}
			#src/jotun/php/file/Image.hx:142: lines 142-144
			if ($y < 0) {
				#src/jotun/php/file/Image.hx:143: characters 5-10
				$y = 0;
			}
			#src/jotun/php/file/Image.hx:145: characters 4-27
			$tx = $x + $width;
			#src/jotun/php/file/Image.hx:146: characters 4-27
			$ty = $y + $width;
			#src/jotun/php/file/Image.hx:148: lines 148-150
			if ($tx > $this->width) {
				#src/jotun/php/file/Image.hx:149: characters 5-20
				$tx = $this->width;
			}
			#src/jotun/php/file/Image.hx:151: lines 151-153
			if ($ty > $this->height) {
				#src/jotun/php/file/Image.hx:152: characters 5-21
				$ty = $this->height;
			}
			#src/jotun/php/file/Image.hx:156: characters 4-94
			$newimg = imagecreatetruecolor($width,$height);
			#src/jotun/php/file/Image.hx:157: lines 157-160
			if ($newimg !== null) {
				#src/jotun/php/file/Image.hx:158: characters 5-105
				imagecopy($newimg,$this->_res,$x,$y,0,0,$tx,$ty);
				#src/jotun/php/file/Image.hx:159: characters 5-20
				$this->_update($newimg);
			}
		}
		#src/jotun/php/file/Image.hx:162: characters 9-20
		return $this;
	}

	/**
	 * @return void
	 */
	public function delete () {
		#src/jotun/php/file/Image.hx:218: characters 3-30
		\unlink($this->name);
	}

	/**
	 * @return void
	 */
	public function dispose () {
		#src/jotun/php/file/Image.hx:222: lines 222-224
		if ($this->_res !== null) {
			#src/jotun/php/file/Image.hx:223: characters 4-51
			imagedestroy($this->_res);
		}
		#src/jotun/php/file/Image.hx:225: characters 3-14
		$this->_res = null;
	}

	/**
	 * Ffit image to size
	 * @param	width
	 * @param	height
	 * @return
	 * 
	 * @param int $width
	 * @param int $height
	 * 
	 * @return IImage
	 */
	public function fit ($width, $height) {
		#src/jotun/php/file/Image.hx:172: lines 172-181
		if ($this->isValid()) {
			#src/jotun/php/file/Image.hx:173: characters 4-28
			$ow = $this->width;
			#src/jotun/php/file/Image.hx:174: characters 4-29
			$oh = $this->height;
			#src/jotun/php/file/Image.hx:176: lines 176-180
			if ($ow >= $oh) {
				#src/jotun/php/file/Image.hx:177: characters 5-58
				$this->resample((int)(\floor($width / $ow * $height + 0.5)), $height, true);
			} else {
				#src/jotun/php/file/Image.hx:179: characters 5-57
				$this->resample($width, (int)(\floor($height / $oh * $width + 0.5)), true);
			}
		}
		#src/jotun/php/file/Image.hx:182: characters 3-14
		return $this;
	}

	/**
	 * @return string
	 */
	public function getExtension () {
		#src/jotun/php/file/Image.hx:39: characters 10-14
		$__hx__switch = ($this->type);
		if ($__hx__switch === 1) {
			#src/jotun/php/file/Image.hx:40: characters 13-25
			return "gif";
		} else if ($__hx__switch === 2) {
			#src/jotun/php/file/Image.hx:41: characters 13-25
			return "jpg";
		} else if ($__hx__switch === 3) {
			#src/jotun/php/file/Image.hx:42: characters 13-25
			return "png";
		} else if ($__hx__switch === 6) {
			#src/jotun/php/file/Image.hx:43: characters 13-25
			return "bmp";
		}
		#src/jotun/php/file/Image.hx:45: characters 3-14
		return null;
	}

	/**
	 * @param int $width
	 * @param int $height
	 * 
	 * @return bool
	 */
	public function isOutBounds ($width, $height) {
		#src/jotun/php/file/Image.hx:186: characters 3-65
		return (($this->width <= $width) && ($this->height <= $height)) === false;
	}

	/**
	 * Check if resource is valid
	 * @return
	 * 
	 * @return bool
	 */
	public function isValid () {
		#src/jotun/php/file/Image.hx:233: characters 3-22
		return $this->_res !== null;
	}

	/**
	 * Open file for location or data string
	 * @param	file
	 * @return
	 * 
	 * @param mixed $file
	 * 
	 * @return IImage
	 */
	public function open ($file) {
		#src/jotun/php/file/Image.hx:71: characters 3-12
		$this->dispose();
		#src/jotun/php/file/Image.hx:72: lines 72-94
		if ($file !== null) {
			#src/jotun/php/file/Image.hx:74: characters 4-65
			$isFile = is_file($file);
			#src/jotun/php/file/Image.hx:75: characters 4-27
			$img = null;
			#src/jotun/php/file/Image.hx:76: lines 76-92
			if ($isFile) {
				#src/jotun/php/file/Image.hx:77: characters 5-16
				$this->name = $file;
				#src/jotun/php/file/Image.hx:78: characters 5-76
				$info = getimagesize($file);
				#src/jotun/php/file/Image.hx:79: characters 5-20
				$this->width = $info[0];
				#src/jotun/php/file/Image.hx:80: characters 5-21
				$this->height = $info[1];
				#src/jotun/php/file/Image.hx:81: characters 5-19
				$this->type = $info[2];
				#src/jotun/php/file/Image.hx:82: characters 12-16
				$__hx__switch = ($this->type);
				if ($__hx__switch === 1) {
					#src/jotun/php/file/Image.hx:83: characters 15-74
					$img = imagecreatefromgif($file);
				} else if ($__hx__switch === 2) {
					#src/jotun/php/file/Image.hx:84: characters 15-75
					$img = imagecreatefromjpeg($file);
				} else if ($__hx__switch === 3) {
					#src/jotun/php/file/Image.hx:85: characters 15-74
					$img = imagecreatefrompng($file);
				} else if ($__hx__switch === 6) {
					#src/jotun/php/file/Image.hx:86: characters 15-75
					$img = imagecreatefromwbmp($file);
				}
			} else {
				#src/jotun/php/file/Image.hx:89: characters 5-67
				$img = imagecreatefromstring($file);
				#src/jotun/php/file/Image.hx:90: characters 5-55
				$this->width = imagesx($this->_res);
				#src/jotun/php/file/Image.hx:91: characters 5-56
				$this->height = imagesy($this->_res);
			}
			#src/jotun/php/file/Image.hx:93: characters 4-14
			$this->_res = $img;
		}
		#src/jotun/php/file/Image.hx:95: characters 3-14
		return $this;
	}

	/**
	 * Change image size
	 * @param	width
	 * @param	height
	 * @param	ratio
	 * @return
	 * 
	 * @param int $width
	 * @param int $height
	 * @param bool $ratio
	 * 
	 * @return IImage
	 */
	public function resample ($width, $height, $ratio = true) {
		#src/jotun/php/file/Image.hx:105: lines 105-126
		if ($ratio === null) {
			$ratio = true;
		}
		#src/jotun/php/file/Image.hx:106: lines 106-124
		if ($this->isValid()) {
			#src/jotun/php/file/Image.hx:107: lines 107-113
			if ($ratio) {
				#src/jotun/php/file/Image.hx:108: lines 108-112
				if ($height >= $width) {
					#src/jotun/php/file/Image.hx:109: characters 14-59
					$width = (int)(\floor($height / $this->height * $this->width + 0.5));
				} else {
					#src/jotun/php/file/Image.hx:111: characters 15-59
					$height = (int)(\floor($width / $this->width * $this->height + 0.5));
				}
			}
			#src/jotun/php/file/Image.hx:114: characters 4-94
			$newimg = imagecreatetruecolor($width,$height);
			#src/jotun/php/file/Image.hx:116: lines 116-123
			if ($newimg !== null) {
				#src/jotun/php/file/Image.hx:117: characters 5-71
				imagealphablending($newimg,false);
				#src/jotun/php/file/Image.hx:118: characters 5-66
				imagesavealpha($newimg,true);
				#src/jotun/php/file/Image.hx:119: characters 5-122
				$alpha = imagecolorallocatealpha($newimg,255,255,255,127);
				#src/jotun/php/file/Image.hx:120: characters 5-110
				imagefilledrectangle($newimg,0,0,$width,$height,$alpha);
				#src/jotun/php/file/Image.hx:121: characters 5-154
				imagecopyresampled($newimg,$this->_res,0,0,0,0,$width,$height,$this->width,$this->height);
				#src/jotun/php/file/Image.hx:122: characters 5-20
				$this->_update($newimg);
			}
		}
		#src/jotun/php/file/Image.hx:125: characters 3-14
		return $this;
	}

	/**
	 * Save modified file
	 * @param	name
	 * @param	type
	 * @return
	 * 
	 * @param string $name
	 * @param mixed $type
	 * @param int $quality
	 * 
	 * @return bool
	 */
	public function save ($name = null, $type = null, $quality = null) {
		#src/jotun/php/file/Image.hx:196: lines 196-213
		if ($this->isValid()) {
			#src/jotun/php/file/Image.hx:197: lines 197-199
			if ($type === null) {
				#src/jotun/php/file/Image.hx:198: characters 5-21
				$type = $this->type;
			}
			#src/jotun/php/file/Image.hx:200: lines 200-202
			if ($name === null) {
				#src/jotun/php/file/Image.hx:201: characters 5-21
				$name = $this->name;
			}
			#src/jotun/php/file/Image.hx:203: lines 203-212
			try {
				#src/jotun/php/file/Image.hx:204: lines 204-209
				if ($type === null) {
					#src/jotun/php/file/Image.hx:208: characters 16-106
					imagejpeg($this->_res,$name,($quality !== null ? $quality : 90));
				} else {
					#src/jotun/php/file/Image.hx:204: characters 12-16
					if (Boot::equal($type, 1) || $type === "GIF" || $type === "gif") {
						#src/jotun/php/file/Image.hx:205: characters 29-82
						imagegif($this->_res,$name);
					} else if (Boot::equal($type, 3) || $type === "PNG" || $type === "png") {
						#src/jotun/php/file/Image.hx:206: characters 29-82
						imagepng($this->_res,$name);
					} else if (Boot::equal($type, 6) || $type === "WBMP" || $type === "wbmp") {
						#src/jotun/php/file/Image.hx:207: characters 31-85
						imagewbmp($this->_res,$name);
					} else {
						#src/jotun/php/file/Image.hx:208: characters 16-106
						imagejpeg($this->_res,$name,($quality !== null ? $quality : 90));
					}
				}
				#src/jotun/php/file/Image.hx:210: characters 5-16
				return true;
			} catch(\Throwable $_g) {
			}
		}
		#src/jotun/php/file/Image.hx:214: characters 3-15
		return false;
	}
}

Boot::registerClass(Image::class, 'jotun.php.file.Image');
