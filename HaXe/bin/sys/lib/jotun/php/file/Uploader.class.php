<?php

// Generated by Haxe 3.4.7
class jotun_php_file_Uploader {
	public function __construct(){}
	static $files;
	static function _sizes() { $args = func_get_args(); return call_user_func_array(self::$_sizes, $args); }
	static $_sizes;
	static $_path = "/";
	static function createPath($q) {
		$p = "";
		jotun_utils_Dice::Values(_hx_explode("/", $q), array(new _hx_lambda(array(&$p), "jotun_php_file_Uploader_0"), 'execute'), null);
	}
	static function save($path, $sizes = null) {
		if(jotun_php_file_Uploader::$_path !== $path) {
			jotun_php_file_Uploader::createPath($path);
			jotun_php_file_Uploader::$_path = $path;
		}
		if($sizes !== null) {
			jotun_php_file_Uploader::$_sizes = $sizes;
		}
		jotun_php_file_Uploader::_verify();
		return jotun_php_file_Uploader::$files;
	}
	static function _getType($file) {
		$ext = strtolower(_hx_explode(".", $file)->pop());
		switch($ext) {
		case "gif":case "jpeg":case "jpg":case "png":{
			return "image";
		}break;
		default:{
			return "document";
		}break;
		}
	}
	static function _verify() {
		$partName = null;
		$lastFile = null;
		$fileStream = null;
		php_Web::parseMultipart(array(new _hx_lambda(array(&$fileStream, &$lastFile, &$partName), "jotun_php_file_Uploader_1"), 'execute'), array(new _hx_lambda(array(&$fileStream), "jotun_php_file_Uploader_2"), 'execute'));
		if($fileStream !== null) {
			$fileStream->close();
		}
		if(_hx_field(_hx_qtype("jotun.php.file.Uploader"), "_sizes") !== null) {
			$image = new jotun_php_file_Image(null);
			jotun_utils_Dice::Values(jotun_php_file_Uploader::$files->{"list"}, array(new _hx_lambda(array(&$image), "jotun_php_file_Uploader_3"), 'execute'), null);
		}
	}
	static function _rename($o, $p) {
		$n = _hx_explode(".", $o);
		$n[$n->length - 1] = _hx_string_or_null($p) . "." . _hx_string_or_null($n->pop());
		return $n->join(".");
	}
	function __toString() { return 'jotun.php.file.Uploader'; }
}
jotun_php_file_Uploader::$files = new jotun_php_file_FileCollection();
function jotun_php_file_Uploader_0(&$p, $v) {
	{
		if(strlen($v) > 0) {
			$p = _hx_string_or_null($p) . _hx_string_or_null($v);
			$tmp = null;
			if(!(!file_exists($p))) {
				$tmp = !is_dir($p);
			} else {
				$tmp = true;
			}
			if($tmp) {
				mkdir($p, 0777);
			}
			$p = _hx_string_or_null($p) . "/";
		}
	}
}
function jotun_php_file_Uploader_1(&$fileStream, &$lastFile, &$partName, $part, $name) {
	{
		if(jotun_tools_Utils::isValid($name, null)) {
			$tmp = null;
			if($name !== null) {
				$tmp = $lastFile !== $name;
			} else {
				$tmp = false;
			}
			if($tmp) {
				$partName = $part;
				$lastFile = $name;
				if($fileStream !== null) {
					$fileStream->close();
				}
				$type = jotun_php_file_Uploader::_getType($name);
				if($type !== null) {
					$int = jotun_Jotun::$tick;
					$nName = null;
					if($int < 0) {
						$nName = 4294967296.0 + $int;
					} else {
						$nName = $int + 0.0;
					}
					$nName1 = Std::string($nName) . "_";
					$nName2 = _hx_string_or_null($nName1) . _hx_string_or_null(jotun_tools_Key::GEN(8, null, null)) . ".";
					$nName3 = _hx_string_or_null($nName2) . _hx_string_or_null(_hx_explode(".", $name)->pop());
					$fileStream = sys_io_File::write(_hx_string_or_null(jotun_php_file_Uploader::$_path) . _hx_string_or_null($nName3), true);
					$tmp1 = jotun_php_file_Uploader::$files;
					$tmp1->add($part, new jotun_php_file_FileInfo($type, $name, $nName3));
				}
			}
		} else {
			$fileStream = null;
		}
	}
}
function jotun_php_file_Uploader_2(&$fileStream, $bytes, $pos, $len) {
	{
		if($fileStream !== null) {
			$fileStream->writeBytes($bytes, 0, $bytes->length);
		}
	}
}
function jotun_php_file_Uploader_3(&$image, $v) {
	{
		if($v->type === "image") {
			$v->sizes = (new _hx_array(array()));
			jotun_utils_Dice::All(jotun_php_file_Uploader::$_sizes, array(new _hx_lambda(array(&$image, &$v), "jotun_php_file_Uploader_4"), 'execute'), null);
			if($v->sizes !== null) {
				$v->output = null;
				$image->delete();
			}
		}
	}
}
function jotun_php_file_Uploader_4(&$image, &$v, $p, $s) {
	{
		$o = _hx_string_or_null(jotun_php_file_Uploader::$_path) . _hx_string_or_null($v->output);
		$image->open($o);
		if($image->isOutBounds(_hx_field($s, "width"), _hx_field($s, "height"))) {
			$image->fit(_hx_field($s, "width"), _hx_field($s, "height"));
			$o = jotun_php_file_Uploader::_rename($o, $p);
			$image->save($o, null, null);
			$v->sizes->push($o);
		} else {
			if(_hx_field($s, "create")) {
				$o = jotun_php_file_Uploader::_rename($o, $p);
				$image->save($o, null, null);
				$v->sizes->push($o);
			}
		}
	}
}
