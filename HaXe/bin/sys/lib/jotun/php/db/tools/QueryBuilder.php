<?php
/**
 * Generated by Haxe 4.3.0
 */

namespace jotun\php\db\tools;

use \php\_Boot\HxAnon;
use \php\Boot;
use \jotun\utils\Filler;
use \jotun\php\db\Clause;
use \jotun\utils\Dice;
use \jotun\php\db\IGate;
use \jotun\php\db\objects\IDataTable;

/**
 * ...
 * @author Rafael Moreira
 */
class QueryBuilder implements IQueryBuilder {
	/**
	 * @var IGate
	 */
	public $_gate;

	/**
	 *
	 *
	 * var q:Dynamic = Jotun.gate.table('users').findJoin(['users.id as UID','users.name as NAME','state.alt as STATE','city.name as CITY'], [
	 * Jotun.gate.builder.leftJoin('user_address', 'address', Clause.EQUAL('address.user_id', 1)),
	 * Jotun.gate.builder.leftJoin('location_state', 'state', Clause.CUSTOM('state.id=address.state_id')),
	 * Jotun.gate.builder.leftJoin('location_city', 'city', 'city.id=address.city_id'),
	 * ], Clause.CUSTOM('users.id<30'));
	 * @param	gate
	 * 
	 * @param IGate $gate
	 * 
	 * @return void
	 */
	public function __construct ($gate) {
		#src/jotun/php/db/tools/QueryBuilder.hx:28: characters 3-15
		$this->_gate = $gate;
	}

	/**
	 * @param mixed $clause
	 * @param mixed[]|\Array_hx $parameters
	 * @param mixed $order
	 * @param string $limit
	 * 
	 * @return string
	 */
	public function _assembleBody ($clause = null, $parameters = null, $order = null, $limit = null) {
		#src/jotun/php/db/tools/QueryBuilder.hx:118: characters 3-21
		$q = "";
		#src/jotun/php/db/tools/QueryBuilder.hx:119: lines 119-120
		if ($clause !== null) {
			#src/jotun/php/db/tools/QueryBuilder.hx:120: characters 4-68
			$q = ($q??'null') . " WHERE " . ($this->_conditions($clause, $parameters, " || ", false)??'null');
		}
		#src/jotun/php/db/tools/QueryBuilder.hx:121: lines 121-122
		if ($order !== null) {
			#src/jotun/php/db/tools/QueryBuilder.hx:122: characters 4-37
			$q = ($q??'null') . " ORDER BY " . ($this->_order($order)??'null');
		}
		#src/jotun/php/db/tools/QueryBuilder.hx:123: lines 123-124
		if ($limit !== null) {
			#src/jotun/php/db/tools/QueryBuilder.hx:124: characters 4-26
			$q = ($q??'null') . " LIMIT " . ($limit??'null');
		}
		#src/jotun/php/db/tools/QueryBuilder.hx:125: characters 3-11
		return $q;
	}

	/**
	 * @param mixed $obj
	 * @param mixed $props
	 * @param string $joiner
	 * @param bool $skip
	 * 
	 * @return string
	 */
	public function _conditions ($obj, $props, $joiner, $skip) {
		#src/jotun/php/db/tools/QueryBuilder.hx:61: lines 61-115
		$_gthis = $this;
		#src/jotun/php/db/tools/QueryBuilder.hx:63: characters 3-28
		$r = new \Array_hx();
		#src/jotun/php/db/tools/QueryBuilder.hx:64: characters 3-25
		$s = $joiner;
		#src/jotun/php/db/tools/QueryBuilder.hx:65: characters 3-21
		$b = true;
		#src/jotun/php/db/tools/QueryBuilder.hx:68: lines 68-106
		if (($obj instanceof Clause)) {
			#src/jotun/php/db/tools/QueryBuilder.hx:69: lines 69-74
			Dice::Values(Boot::dynamicField($obj, 'conditions'), function ($v) use (&$skip, &$r, &$_gthis, &$props, &$joiner) {
				#src/jotun/php/db/tools/QueryBuilder.hx:70: characters 5-44
				$v = $_gthis->_conditions($v, $props, $joiner, $skip);
				#src/jotun/php/db/tools/QueryBuilder.hx:71: lines 71-73
				if ($v !== null) {
					#src/jotun/php/db/tools/QueryBuilder.hx:72: characters 6-21
					$r->offsetSet($r->length, $v);
				}
			});
			#src/jotun/php/db/tools/QueryBuilder.hx:75: characters 4-20
			$s = $obj->joiner();
		} else if (($obj instanceof \Array_hx)) {
			#src/jotun/php/db/tools/QueryBuilder.hx:79: lines 79-84
			Dice::All($obj, function ($p, $v) use (&$skip, &$r, &$_gthis, &$props, &$joiner) {
				#src/jotun/php/db/tools/QueryBuilder.hx:80: characters 5-83
				$v = $_gthis->_conditions($v, $props, (($v instanceof Clause) ? $v->joiner() : $joiner), $skip);
				#src/jotun/php/db/tools/QueryBuilder.hx:81: lines 81-83
				if ($v !== null) {
					#src/jotun/php/db/tools/QueryBuilder.hx:82: characters 6-21
					$r->offsetSet($r->length, $v);
				}
			});
		} else if (is_string($obj)) {
			#src/jotun/php/db/tools/QueryBuilder.hx:87: characters 4-21
			$r->offsetSet($r->length, $obj);
		} else if ($obj !== null) {
			#src/jotun/php/db/tools/QueryBuilder.hx:91: lines 91-105
			if ((Boot::dynamicField($obj, 'value') instanceof \Array_hx)) {
				#src/jotun/php/db/tools/QueryBuilder.hx:92: characters 5-61
				$r->offsetSet($r->length, Filler::to(Boot::dynamicField($obj, 'condition'), new HxAnon(["p" => Boot::dynamicField($obj, 'param')])));
				#src/jotun/php/db/tools/QueryBuilder.hx:93: lines 93-95
				Dice::All(Boot::dynamicField($obj, 'value'), function ($p, $v) use (&$props) {
					#src/jotun/php/db/tools/QueryBuilder.hx:94: characters 6-29
					$props[Boot::dynamicField($props, 'length')] = $v;
				});
			} else if ($skip) {
				#src/jotun/php/db/tools/QueryBuilder.hx:98: characters 6-97
				$r->offsetSet($r->length, Filler::splitter(Filler::to(Boot::dynamicField($obj, 'condition'), new HxAnon(["p" => Boot::dynamicField($obj, 'param')])), "?", \Array_hx::wrap([Boot::dynamicField($obj, 'value')])));
			} else {
				#src/jotun/php/db/tools/QueryBuilder.hx:100: characters 6-62
				$r->offsetSet($r->length, Filler::to(Boot::dynamicField($obj, 'condition'), new HxAnon(["p" => Boot::dynamicField($obj, 'param')])));
				#src/jotun/php/db/tools/QueryBuilder.hx:101: lines 101-103
				if (!Boot::dynamicField($obj, 'skip')) {
					#src/jotun/php/db/tools/QueryBuilder.hx:102: characters 7-38
					$props[Boot::dynamicField($props, 'length')] = Boot::dynamicField($obj, 'value');
				}
			}
		}
		#src/jotun/php/db/tools/QueryBuilder.hx:108: lines 108-113
		if ($r->length > 0) {
			#src/jotun/php/db/tools/QueryBuilder.hx:109: characters 4-20
			$b = $r->length > 1;
			#src/jotun/php/db/tools/QueryBuilder.hx:110: characters 4-54
			return ((($b ? "(" : ""))??'null') . ($r->join($s)??'null') . ((($b ? ")" : ""))??'null');
		} else {
			#src/jotun/php/db/tools/QueryBuilder.hx:112: characters 4-15
			return null;
		}
	}

	/**
	 * @param mixed $parameters
	 * @param mixed[]|\Array_hx $dataset
	 * 
	 * @return string
	 */
	public function _insert ($parameters, $dataset) {
		#src/jotun/php/db/tools/QueryBuilder.hx:32: characters 3-28
		$r = new \Array_hx();
		#src/jotun/php/db/tools/QueryBuilder.hx:33: characters 3-28
		$q = new \Array_hx();
		#src/jotun/php/db/tools/QueryBuilder.hx:34: characters 3-18
		$i = 0;
		#src/jotun/php/db/tools/QueryBuilder.hx:35: lines 35-40
		Dice::All($parameters, function ($p, $v) use (&$dataset, &$i, &$r, &$q) {
			#src/jotun/php/db/tools/QueryBuilder.hx:36: characters 4-12
			$r->offsetSet($i, $p);
			#src/jotun/php/db/tools/QueryBuilder.hx:37: characters 4-14
			$q->offsetSet($i, "?");
			#src/jotun/php/db/tools/QueryBuilder.hx:38: characters 4-7
			$i += 1;
			#src/jotun/php/db/tools/QueryBuilder.hx:39: characters 4-31
			$dataset->offsetSet($dataset->length, $v);
		});
		#src/jotun/php/db/tools/QueryBuilder.hx:41: characters 3-62
		return "(" . ($r->join(",")??'null') . ") VALUES (" . ($q->join(",")??'null') . ")";
	}

	/**
	 * @param mixed $obj
	 * 
	 * @return string
	 */
	public function _order ($obj) {
		#src/jotun/php/db/tools/QueryBuilder.hx:56: characters 3-28
		$r = new \Array_hx();
		#src/jotun/php/db/tools/QueryBuilder.hx:57: characters 3-98
		Dice::All($obj, function ($p, $v) use (&$r) {
			#src/jotun/php/db/tools/QueryBuilder.hx:57: characters 49-93
			$r->offsetSet($r->length, ($p??'null') . ((($v !== null ? " " . \Std::string($v) : ""))??'null'));
		});
		#src/jotun/php/db/tools/QueryBuilder.hx:58: characters 3-21
		return $r->join(",");
	}

	/**
	 * @param mixed $parameters
	 * @param mixed[]|\Array_hx $dataset
	 * 
	 * @return string
	 */
	public function _updateSet ($parameters, $dataset) {
		#src/jotun/php/db/tools/QueryBuilder.hx:46: characters 3-28
		$q = new \Array_hx();
		#src/jotun/php/db/tools/QueryBuilder.hx:47: lines 47-50
		Dice::All($parameters, function ($p, $v) use (&$dataset, &$q) {
			#src/jotun/php/db/tools/QueryBuilder.hx:48: characters 4-26
			$q->offsetSet($q->length, ($p??'null') . "=?");
			#src/jotun/php/db/tools/QueryBuilder.hx:49: characters 4-31
			$dataset->offsetSet($dataset->length, $v);
		});
		#src/jotun/php/db/tools/QueryBuilder.hx:51: characters 3-21
		return $q->join(",");
	}

	/**
	 * @param string $table
	 * @param mixed $parameters
	 * 
	 * @return ICommand
	 */
	public function add ($table, $parameters = null) {
		#src/jotun/php/db/tools/QueryBuilder.hx:129: characters 3-35
		$dataset = new \Array_hx();
		#src/jotun/php/db/tools/QueryBuilder.hx:130: characters 3-124
		return $this->_gate->prepare("INSERT INTO " . ($table??'null') . ($this->_insert($parameters, $dataset)??'null') . ($this->_assembleBody(null, $dataset)??'null') . ";", $dataset);
	}

	/**
	 * @param string $from
	 * @param string $to
	 * @param mixed $clause
	 * @param \Closure $filter
	 * @param string $limit
	 * 
	 * @return mixed[]|\Array_hx
	 */
	public function copy ($from, $to, $clause = null, $filter = null, $limit = null) {
		#src/jotun/php/db/tools/QueryBuilder.hx:156: lines 156-168
		$_gthis = $this;
		#src/jotun/php/db/tools/QueryBuilder.hx:157: characters 3-69
		$entries = $this->find("*", $from, $clause, null, $limit)->result;
		#src/jotun/php/db/tools/QueryBuilder.hx:158: characters 3-34
		$result = new \Array_hx();
		#src/jotun/php/db/tools/QueryBuilder.hx:159: lines 159-166
		Dice::Values($entries, function ($v) use (&$to, &$filter, &$_gthis, &$result) {
			#src/jotun/php/db/tools/QueryBuilder.hx:160: lines 160-162
			if ($filter !== null) {
				#src/jotun/php/db/tools/QueryBuilder.hx:161: characters 5-18
				$v = $filter($v);
			}
			#src/jotun/php/db/tools/QueryBuilder.hx:163: lines 163-165
			if ($_gthis->add($to, $v)->success) {
				#src/jotun/php/db/tools/QueryBuilder.hx:164: characters 5-30
				$result->offsetSet($result->length, $v);
			}
		});
		#src/jotun/php/db/tools/QueryBuilder.hx:167: characters 3-16
		return $result;
	}

	/**
	 * @param string $table
	 * @param mixed $clause
	 * @param mixed $order
	 * @param string $limit
	 * 
	 * @return ICommand
	 */
	public function delete ($table, $clause = null, $order = null, $limit = null) {
		#src/jotun/php/db/tools/QueryBuilder.hx:152: characters 3-31
		$parameters = new \Array_hx();
		#src/jotun/php/db/tools/QueryBuilder.hx:153: characters 3-115
		return $this->_gate->prepare("DELETE FROM " . ($table??'null') . ($this->_assembleBody($clause, $parameters, $order, $limit)??'null') . ";", $parameters);
	}

	/**
	 * @param string $table
	 * @param string $reference
	 * @param string $key
	 * @param string $target
	 * @param string $field
	 * @param string $delete
	 * @param string $update
	 * 
	 * @return ICommand
	 */
	public function fKey ($table, $reference, $key = null, $target = null, $field = null, $delete = "RESTRICT", $update = "RESTRICT") {
		#src/jotun/php/db/tools/QueryBuilder.hx:171: lines 171-175
		if ($delete === null) {
			$delete = "RESTRICT";
		}
		if ($update === null) {
			$update = "RESTRICT";
		}
		if ($key === null) {
			#src/jotun/php/db/tools/QueryBuilder.hx:172: characters 4-81
			return $this->_gate->query("ALTER TABLE " . ($table??'null') . " DROP FOREIGN KEY " . ($reference??'null'));
		} else {
			#src/jotun/php/db/tools/QueryBuilder.hx:174: characters 4-230
			return $this->_gate->query("ALTER TABLE " . ($table??'null') . " ADD CONSTRAINT " . ($reference??'null') . " FOREIGN KEY (" . ($key??'null') . ") REFERENCES " . ($target??'null') . "(" . ($field??'null') . ") ON DELETE " . (\mb_strtoupper($delete)??'null') . " ON UPDATE " . (\mb_strtoupper($update)??'null') . ";");
		}
	}

	/**
	 * @param mixed $fields
	 * @param mixed $table
	 * @param mixed $clause
	 * @param mixed $order
	 * @param string $limit
	 * 
	 * @return IExtCommand
	 */
	public function find ($fields, $table, $clause = null, $order = null, $limit = null) {
		#src/jotun/php/db/tools/QueryBuilder.hx:134: lines 134-136
		if (($fields instanceof \Array_hx)) {
			#src/jotun/php/db/tools/QueryBuilder.hx:135: characters 4-29
			$fields = $fields->join(",");
		}
		#src/jotun/php/db/tools/QueryBuilder.hx:137: characters 3-27
		$joinner = "";
		#src/jotun/php/db/tools/QueryBuilder.hx:138: lines 138-141
		if (($table instanceof \Array_hx)) {
			#src/jotun/php/db/tools/QueryBuilder.hx:139: characters 4-37
			$main = $table->shift();
			#src/jotun/php/db/tools/QueryBuilder.hx:140: characters 4-40
			$table = \Std::string($main) . " " . \Std::string($table->join(" "));
		}
		#src/jotun/php/db/tools/QueryBuilder.hx:142: characters 3-31
		$parameters = new \Array_hx();
		#src/jotun/php/db/tools/QueryBuilder.hx:143: characters 3-128
		return $this->_gate->query("SELECT " . \Std::string($fields) . " FROM " . \Std::string($table) . ($this->_assembleBody($clause, $parameters, $order, $limit)??'null') . ";", $parameters);
	}

	/**
	 * @param mixed $table
	 * @param string $name
	 * @param mixed $clause
	 * 
	 * @return string
	 */
	public function fullOuterJoin ($table, $name = null, $clause = null) {
		#src/jotun/php/db/tools/QueryBuilder.hx:207: characters 3-50
		return "FULL " . ($this->outerJoin($table, $name, $clause)??'null');
	}

	/**
	 * @param mixed $table
	 * @param string $name
	 * @param mixed $clause
	 * 
	 * @return string
	 */
	public function join ($table, $name = null, $clause = null) {
		#src/jotun/php/db/tools/QueryBuilder.hx:187: characters 3-162
		return "JOIN " . (((($table instanceof IDataTable) ? Boot::dynamicField($table, 'name') : $table))??'null') . ((($name !== null ? " AS " . ($name??'null') : ""))??'null') . " ON " . ($this->_conditions($clause, new \Array_hx(), " || ", true)??'null');
	}

	/**
	 * @param mixed $table
	 * @param string $name
	 * @param mixed $clause
	 * 
	 * @return string
	 */
	public function leftJoin ($table, $name = null, $clause = null) {
		#src/jotun/php/db/tools/QueryBuilder.hx:191: characters 3-45
		return "LEFT " . ($this->join($table, $name, $clause)??'null');
	}

	/**
	 * @param mixed $table
	 * @param string $name
	 * @param mixed $clause
	 * 
	 * @return string
	 */
	public function leftOuterJoin ($table, $name = null, $clause = null) {
		#src/jotun/php/db/tools/QueryBuilder.hx:199: characters 3-50
		return "LEFT " . ($this->outerJoin($table, $name, $clause)??'null');
	}

	/**
	 * @param mixed $table
	 * @param string $name
	 * @param mixed $clause
	 * 
	 * @return string
	 */
	public function outerJoin ($table, $name = null, $clause = null) {
		#src/jotun/php/db/tools/QueryBuilder.hx:195: characters 3-46
		return "OUTER " . ($this->join($table, $name, $clause)??'null');
	}

	/**
	 * @param string $table
	 * @param string $to
	 * 
	 * @return ICommand
	 */
	public function rename ($table, $to) {
		#src/jotun/php/db/tools/QueryBuilder.hx:183: characters 3-89
		return $this->_gate->prepare("RENAME TABLE :oldname TO :newname", new HxAnon([
			"oldname" => $table,
			"newname" => $to,
		]));
	}

	/**
	 * @param mixed $table
	 * @param string $name
	 * @param mixed $clause
	 * 
	 * @return string
	 */
	public function rightOuterJoin ($table, $name = null, $clause = null) {
		#src/jotun/php/db/tools/QueryBuilder.hx:203: characters 3-51
		return "RIGHT " . ($this->outerJoin($table, $name, $clause)??'null');
	}

	/**
	 * @param string $table
	 * 
	 * @return ICommand
	 */
	public function truncate ($table) {
		#src/jotun/php/db/tools/QueryBuilder.hx:179: characters 3-57
		return $this->_gate->prepare("TRUNCATE :table", new HxAnon(["table" => $table]));
	}

	/**
	 * @param string $table
	 * @param mixed $clause
	 * @param mixed $parameters
	 * @param mixed $order
	 * @param string $limit
	 * 
	 * @return ICommand
	 */
	public function update ($table, $clause = null, $parameters = null, $order = null, $limit = null) {
		#src/jotun/php/db/tools/QueryBuilder.hx:147: characters 3-35
		$dataset = new \Array_hx();
		#src/jotun/php/db/tools/QueryBuilder.hx:148: characters 3-148
		return $this->_gate->prepare("UPDATE " . ($table??'null') . " SET " . ($this->_updateSet($parameters, $dataset)??'null') . ($this->_assembleBody($clause, $dataset, $order, $limit)??'null') . ";", $dataset);
	}
}

Boot::registerClass(QueryBuilder::class, 'jotun.php.db.tools.QueryBuilder');
