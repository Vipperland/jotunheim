<?php
/**
 * Generated by Haxe 4.3.0
 */

namespace jotun\gateway\domain;

use \jotun\serial\Packager;
use \php\Boot;
use \jotun\Jotun;
use \jotun\tools\Utils;
use \php\_Boot\HxString;
use \jotun\gateway\database\objects\UserSessionObject;

/**
 * ...
 * @author Rafael Moreira
 */
class BasicSessionInput extends InputCore {
	/**
	 * @var string
	 */
	public $_testToken;
	/**
	 * @var int
	 */
	public $_tokenStatus;
	/**
	 * @var UserSessionObject
	 */
	public $session;

	/**
	 * @return void
	 */
	public function __construct () {
		#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:23: characters 3-10
		parent::__construct();
		#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:24: characters 3-19
		$this->_loadAuthToken();
	}

	/**
	 * @param int $status
	 * 
	 * @return void
	 */
	public function _disposeSession ($status) {
		#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:37: characters 3-24
		$this->_tokenStatus = $status;
		#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:38: lines 38-41
		if ($this->session !== null) {
			#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:39: characters 4-20
			$this->session->revoke();
			#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:40: characters 4-18
			$this->session = null;
		}
	}

	/**
	 * @return void
	 */
	public function _loadAuthToken () {
		#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:45: characters 3-54
		$authorization = Jotun::$header->getOAuth();
		#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:46: lines 46-48
		if (($this->_testToken !== null) && !Utils::isValid($authorization)) {
			#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:47: characters 4-30
			$authorization = $this->_testToken;
		}
		#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:49: lines 49-68
		if (Utils::isValid($authorization)) {
			#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:50: characters 4-56
			$authorization = Packager::decodeBase64($authorization);
			#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:51: lines 51-65
			if (\mb_substr($authorization, 0, mb_strlen("(y)=>")) === "(y)=>") {
				#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:52: characters 5-106
				$authorization = HxString::substring($authorization, mb_strlen("(y)=>"), mb_strlen($authorization));
				#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:53: characters 5-38
				$this->session = new UserSessionObject();
				#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:54: lines 54-62
				if ($this->session->load($authorization)) {
					#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:55: lines 55-59
					if ($this->session->isValid()) {
						#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:56: characters 7-28
						$this->session->exposeToken();
					} else {
						#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:58: characters 7-55
						$this->_disposeSession(1060);
					}
				} else {
					#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:61: characters 6-51
					$this->_disposeSession(1020);
				}
			} else {
				#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:64: characters 5-53
				$this->_disposeSession(1010);
			}
		} else {
			#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:67: characters 4-53
			$this->_disposeSession(1000);
		}
	}

	/**
	 * @return int
	 */
	public function getTokenSatus () {
		#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:19: characters 3-22
		return $this->_tokenStatus;
	}

	/**
	 * @param string $token
	 * 
	 * @return void
	 */
	public function setTestToken ($token) {
		#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:30: characters 3-21
		$this->_testToken = $token;
		#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:31: lines 31-33
		if ($this->_testToken !== null) {
			#src+extras/basic+gateway/jotun/gateway/domain/BasicSessionInput.hx:32: characters 4-20
			$this->_loadAuthToken();
		}
	}
}

Boot::registerClass(BasicSessionInput::class, 'jotun.gateway.domain.BasicSessionInput');
