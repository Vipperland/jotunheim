<?php
/**
 * Generated by Haxe 4.3.0
 */

namespace jotun\gateway\database\objects;

use \jotun\serial\Packager;
use \php\_Boot\HxAnon;
use \jotun\gateway\domain\OutputCore;
use \jotun\utils\Omnitools;
use \php\Boot;
use \jotun\php\db\Clause;
use \jotun\Jotun;
use \jotun\tools\Utils;
use \jotun\gateway\database\SessionDataAccess;
use \jotun\gateway\domain\zones\pass\IPassCarrier;

/**
 * ...
 * @author
 */
class ZoneCoreSession extends ZoneCoreObject {
	/**
	 * @var string
	 */
	const OAUTH_HEAD_IN = "(y)=>";
	/**
	 * @var string
	 */
	const OAUTH_HEAD_OUT = "(y)<=";

	/**
	 * @var float
	 */
	public $_ctd;
	/**
	 * @var string
	 */
	public $_device;
	/**
	 * @var string
	 */
	public $_ip;
	/**
	 * @var string
	 */
	public $_token;
	/**
	 * @var string
	 */
	public $_uid;
	/**
	 * @var float
	 */
	public $_upd;
	/**
	 * @var IPassCarrier
	 */
	public $carrier;

	/**
	 * @return void
	 */
	public function __construct () {
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:47: characters 3-10
		parent::__construct();
	}

	/**
	 * @return IPassCarrier
	 */
	public function _loadCarrier () {
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:43: characters 3-14
		return null;
	}

	/**
	 * @return void
	 */
	public function drop () {
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:105: lines 105-109
		$_gthis = $this;
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:106: lines 106-108
		$this->RunSQL(function () use (&$_gthis) {
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:107: characters 4-94
			(Boot::typedCast(Boot::getClass(SessionDataAccess::class), $_gthis->get__database()))->get_user_session()->deleteOne(Clause::EQUAL("_token", $_gthis->_token));
		});
	}

	/**
	 * @return void
	 */
	public function dropAll () {
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:111: lines 111-117
		$_gthis = $this;
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:112: lines 112-116
		if ($this->isValid()) {
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:113: lines 113-115
			$this->RunSQL(function () use (&$_gthis) {
				#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:114: characters 5-88
				(Boot::typedCast(Boot::getClass(SessionDataAccess::class), $_gthis->get__database()))->get_user_session()->delete(Clause::EQUAL("_uid", $_gthis->_uid));
			});
		}
	}

	/**
	 * @param bool $force
	 * 
	 * @return void
	 */
	public function exposeCarrier ($force = null) {
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:135: lines 135-137
		if (($this->get_carrier() === null) && $force) {
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:136: characters 4-18
			$this->_loadCarrier();
		}
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:138: lines 138-140
		if ($this->get_carrier() !== null) {
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:139: characters 4-71
			OutputCore::getInstance()->object("carrier")->info = $this->get_carrier()->getInfo();
		}
	}

	/**
	 * @return void
	 */
	public function exposeToken () {
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:124: characters 3-53
		$token = "(y)<=";
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:125: lines 125-130
		if ($this->isValid()) {
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:126: characters 4-19
			$token = ($token??'null') . ($this->_token??'null');
		} else {
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:128: characters 4-22
			$token = ($token??'null') . "EXPIRED";
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:129: characters 4-10
			$this->drop();
		}
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:131: characters 3-71
		OutputCore::getInstance()->registerOAuth(Packager::encodeBase64($token));
	}

	/**
	 * @return string
	 */
	public function getToken () {
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:120: characters 3-33
		return "(y)<=" . ($this->_token??'null');
	}

	/**
	 * @return IPassCarrier
	 */
	public function get_carrier () {
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:39: characters 3-24
		return $this->_loadCarrier();
	}

	/**
	 * @return bool
	 */
	public function isValid () {
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:93: characters 3-52
		return (Omnitools::timeFromNow(168) - $this->_upd) > 0;
	}

	/**
	 * @param string $oauth
	 * 
	 * @return bool
	 */
	public function load ($oauth) {
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:77: lines 77-90
		$_gthis = $this;
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:78: lines 78-80
		$current = $this->RunSQL(function () use (&$_gthis, &$oauth) {
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:79: characters 4-103
			return (Boot::typedCast(Boot::getClass(SessionDataAccess::class), $_gthis->get__database()))->get_user_session()->findOne("*", Clause::EQUAL("_token", $oauth));
		});
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:81: lines 81-88
		if ($current !== null) {
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:82: characters 4-23
			$this->_uid = $current->_uid;
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:83: characters 4-27
			$this->_token = $current->_token;
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:84: characters 4-21
			$this->_ip = $current->_ip;
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:85: characters 4-29
			$this->_device = $current->_device;
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:86: characters 4-23
			$this->_ctd = $current->_ctd;
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:87: characters 4-23
			$this->_upd = $current->_upd;
		}
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:89: characters 3-25
		return $current !== null;
	}

	/**
	 * @return void
	 */
	public function refresh () {
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:96: lines 96-103
		$_gthis = $this;
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:97: lines 97-102
		if (($this->_uid !== null) && ($this->_token !== null)) {
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:98: characters 4-30
			$this->_upd = Omnitools::timeNow();
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:99: lines 99-101
			$this->RunSQL(function () use (&$_gthis) {
				#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:100: characters 5-108
				(Boot::typedCast(Boot::getClass(SessionDataAccess::class), $_gthis->get__database()))->get_user_session()->updateOne(new HxAnon(["_upd" => $_gthis->_upd]), Clause::EQUAL("_token", $_gthis->_token));
			});
		}
	}

	/**
	 * @return void
	 */
	public function revoke () {
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:144: characters 3-107
		OutputCore::getInstance()->registerOAuth(Packager::encodeBase64("(y)<=" . "REVOKE"));
	}

	/**
	 * @param string $id
	 * @param string $device
	 * 
	 * @return bool
	 */
	public function save ($id, $device) {
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:50: lines 50-75
		$_gthis = $this;
		#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:51: lines 51-74
		if (($this->_token === null) && ($this->_uid === null)) {
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:52: characters 4-13
			$this->_uid = $id;
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:53: characters 4-39
			$this->_token = Omnitools::genRandomIDx65();
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:54: characters 4-29
			$this->_ip = Jotun::$domain->client;
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:55: characters 4-43
			$this->_device = Utils::getValidOne($device, "");
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:56: characters 4-30
			$this->_ctd = Omnitools::timeNow();
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:57: characters 4-15
			$this->_upd = $this->_ctd;
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:58: lines 58-71
			if (Boot::dynamicField($this->RunSQL(function () use (&$id, &$_gthis) {
				#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:59: lines 59-66
				return (Boot::typedCast(Boot::getClass(SessionDataAccess::class), $_gthis->get__database()))->get_user_session()->add(new HxAnon([
					"_uid" => $id,
					"_token" => $_gthis->_token,
					"_ip" => $_gthis->_ip,
					"_device" => $_gthis->_device,
					"_ctd" => $_gthis->_ctd,
					"_upd" => $_gthis->_upd,
				]));
			}), 'success')) {
				#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:68: characters 5-16
				return true;
			} else {
				#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:70: characters 5-52
				return $this->_error(1030);
			}
		} else {
			#src+extras/basic+gateway/jotun/gateway/database/objects/ZoneCoreSession.hx:73: characters 4-55
			return $this->_error(1040);
		}
	}
}

Boot::registerClass(ZoneCoreSession::class, 'jotun.gateway.database.objects.ZoneCoreSession');
Boot::registerGetters('jotun\\gateway\\database\\objects\\ZoneCoreSession', [
	'carrier' => true
]);
