<?php

// Generated by Haxe 3.4.7
class sirius_php_file_Image implements sirius_php_file_IImage{
	public function __construct($file = null) {
		if(!php_Boot::$skip_constructor) {
		if($file !== null) {
			$this->open($file);
		}
	}}
	public $_res;
	public $name;
	public $width;
	public $height;
	public $type;
	public function _update($resource) {
		$this->dispose();
		$this->_res = $resource;
		$this->width = imagesx($this->_res);
		$this->height = imagesy($this->_res);
	}
	public function open($file) {
		$this->dispose();
		if($file !== null) {
			$isFile = is_file($file);
			$img = null;
			if($isFile) {
				$this->name = $file;
				$info = getimagesize($file);
				$this->width = $info[0];
				$this->height = $info[1];
				$this->type = $info[2];
				{
					$_g = $this->type;
					switch($_g) {
					case 1:{
						$img = imagecreatefromgif($file);
					}break;
					case 2:{
						$img = imagecreatefromjpeg($file);
					}break;
					case 3:{
						$img = imagecreatefrompng($file);
					}break;
					case 6:{
						$img = imagecreatefromwbmp($file);
					}break;
					}
				}
			} else {
				$img = imagecreatefromstring($file);
				$this->width = imagesx($this->_res);
				$this->height = imagesy($this->_res);
			}
			$this->_res = $img;
		}
		return $this;
	}
	public function resample($width, $height, $ratio = null) {
		if($ratio === null) {
			$ratio = true;
		}
		if($this->isValid()) {
			if($ratio) {
				$aNeg = $height < 0;
				$bNeg = $width < 0;
				$tmp = null;
				if($aNeg !== $bNeg) {
					$tmp = $aNeg;
				} else {
					$tmp = $height >= $width;
				}
				if($tmp) {
					$int = $height;
					$b = null;
					if($int < 0) {
						$b = 4294967296.0 + $int;
					} else {
						$b = $int + 0.0;
					}
					$int1 = $this->height;
					$b1 = null;
					if($int1 < 0) {
						$b1 = 4294967296.0 + $int1;
					} else {
						$b1 = $int1 + 0.0;
					}
					$int2 = $this->width;
					$width1 = null;
					if($int2 < 0) {
						$width1 = 4294967296.0 + $int2;
					} else {
						$width1 = $int2 + 0.0;
					}
					$width = Math::round($width1 * ($b / $b1));
				} else {
					$int3 = $width;
					$b2 = null;
					if($int3 < 0) {
						$b2 = 4294967296.0 + $int3;
					} else {
						$b2 = $int3 + 0.0;
					}
					$int4 = $this->width;
					$b3 = null;
					if($int4 < 0) {
						$b3 = 4294967296.0 + $int4;
					} else {
						$b3 = $int4 + 0.0;
					}
					$int5 = $this->height;
					$height1 = null;
					if($int5 < 0) {
						$height1 = 4294967296.0 + $int5;
					} else {
						$height1 = $int5 + 0.0;
					}
					$height = Math::round($height1 * ($b2 / $b3));
				}
			}
			$newimg = imagecreatetruecolor($width, $height);
			if($newimg !== null) {
				imagealphablending($newimg, false);
				imagesavealpha($newimg, true);
				$alpha = imagecolorallocatealpha($newimg, 255, 255, 255, 127);
				imagefilledrectangle($newimg, 0, 0, $width, $height, $alpha);
				imagecopyresampled($newimg, $this->_res, 0, 0, 0, 0, $width, $height, $this->width, $this->height);
				$this->_update($newimg);
			}
		}
		return $this;
	}
	public function crop($x, $y, $width, $height) {
		if($this->isValid()) {
			$aNeg = 0 < 0;
			$bNeg = $x < 0;
			$tmp = null;
			if($aNeg !== $bNeg) {
				$tmp = $aNeg;
			} else {
				$tmp = 0 > $x;
			}
			if($tmp) {
				$x = 0;
			}
			$aNeg1 = 0 < 0;
			$bNeg1 = $y < 0;
			$tmp1 = null;
			if($aNeg1 !== $bNeg1) {
				$tmp1 = $aNeg1;
			} else {
				$tmp1 = 0 > $y;
			}
			if($tmp1) {
				$y = 0;
			}
			$tx = $x + $width;
			$ty = $y + $width;
			$b = $this->width;
			$aNeg2 = $tx < 0;
			$bNeg2 = $b < 0;
			$tmp2 = null;
			if($aNeg2 !== $bNeg2) {
				$tmp2 = $aNeg2;
			} else {
				$tmp2 = $tx > $b;
			}
			if($tmp2) {
				$tx = $this->width;
			}
			$b1 = $this->height;
			$aNeg3 = $ty < 0;
			$bNeg3 = $b1 < 0;
			$tmp3 = null;
			if($aNeg3 !== $bNeg3) {
				$tmp3 = $aNeg3;
			} else {
				$tmp3 = $ty > $b1;
			}
			if($tmp3) {
				$ty = $this->height;
			}
			$newimg = imagecreatetruecolor($width, $height);
			if($newimg !== null) {
				imagecopy($newimg, $this->_res, $x, $y, 0, 0, $tx, $ty);
				$this->_update($newimg);
			}
		}
		return $this;
	}
	public function fit($width, $height) {
		if($this->isValid()) {
			$ow = $this->width;
			$oh = $this->height;
			$aNeg = $ow < 0;
			$bNeg = $oh < 0;
			$tmp = null;
			if($aNeg !== $bNeg) {
				$tmp = $aNeg;
			} else {
				$tmp = $ow >= $oh;
			}
			if($tmp) {
				$int = $height;
				$tmp1 = null;
				if($int < 0) {
					$tmp1 = 4294967296.0 + $int;
				} else {
					$tmp1 = $int + 0.0;
				}
				$int1 = $width;
				$tmp2 = null;
				if($int1 < 0) {
					$tmp2 = 4294967296.0 + $int1;
				} else {
					$tmp2 = $int1 + 0.0;
				}
				$int2 = $ow;
				$tmp3 = null;
				if($int2 < 0) {
					$tmp3 = 4294967296.0 + $int2;
				} else {
					$tmp3 = $int2 + 0.0;
				}
				$this->resample(Math::round($tmp1 * ($tmp2 / $tmp3)), $height, true);
			} else {
				$int3 = $width;
				$tmp4 = null;
				if($int3 < 0) {
					$tmp4 = 4294967296.0 + $int3;
				} else {
					$tmp4 = $int3 + 0.0;
				}
				$int4 = $height;
				$tmp5 = null;
				if($int4 < 0) {
					$tmp5 = 4294967296.0 + $int4;
				} else {
					$tmp5 = $int4 + 0.0;
				}
				$int5 = $oh;
				$tmp6 = null;
				if($int5 < 0) {
					$tmp6 = 4294967296.0 + $int5;
				} else {
					$tmp6 = $int5 + 0.0;
				}
				$this->resample($width, Math::round($tmp4 * ($tmp5 / $tmp6)), true);
			}
		}
		return $this;
	}
	public function save($name = null, $type = null) {
		if($this->isValid()) {
			$dir = dirname($name);
			if(!is_dir($dir)) {
				$path = haxe_io_Path::addTrailingSlash($dir);
				$_p = null;
				$parts = (new _hx_array(array()));
				while(true) {
					$_p = haxe_io_Path::directory($path);
					if(!($path !== $_p)) {
						break;
					}
					$parts->unshift($path);
					$path = $_p;
				}
				{
					$_g = 0;
					while($_g < $parts->length) {
						$part = $parts[$_g];
						$_g = $_g + 1;
						$tmp = null;
						if(_hx_char_code_at($part, strlen($part) - 1) !== 58) {
							$tmp = !file_exists($part);
						} else {
							$tmp = false;
						}
						if($tmp) {
							@mkdir($part, 493);
						}
						unset($tmp,$part);
					}
				}
			}
			if($type === null) {
				$type = $this->type;
			}
			if($name === null) {
				$name = $this->name;
			}
			try {
				if($type === null) {
					imagejpeg($this->_res, $name, 95);
				} else {
					switch($type) {
					case 1:{
						imagegif($this->_res, $name);
					}break;
					case 3:{
						imagepng($this->_res, $name);
					}break;
					case 6:{
						imagewbmp($this->_res, $name);
					}break;
					default:{
						imagejpeg($this->_res, $name, 95);
					}break;
					}
				}
				return true;
			}catch(Exception $__hx__e) {
				$_ex_ = ($__hx__e instanceof HException) && $__hx__e->getCode() == null ? $__hx__e->e : $__hx__e;
				$e = $_ex_;
				{
				}
			}
		}
		return false;
	}
	public function dispose() {
		if(_hx_field($this, "_res") !== null) {
			imagedestroy($this->_res);
		}
		$this->_res = null;
	}
	public function isValid() {
		return _hx_field($this, "_res") !== null;
	}
	public function __call($m, $a) {
		if(isset($this->$m) && is_callable($this->$m))
			return call_user_func_array($this->$m, $a);
		else if(isset($this->__dynamics[$m]) && is_callable($this->__dynamics[$m]))
			return call_user_func_array($this->__dynamics[$m], $a);
		else if('toString' == $m)
			return $this->__toString();
		else
			throw new HException('Unable to call <'.$m.'>');
	}
	function __toString() { return 'sirius.php.file.Image'; }
}
