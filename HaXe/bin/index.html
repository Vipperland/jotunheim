<!DOCTYPE html>
<html lang="en">
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta charset="utf-8">
		<title></title>
		<link rel="stylesheet" href="assets/icons/pro.min.css">
		<script type="text/javascript" src="jotun/api.jotun.js"></script>
		<link rel="preconnect" href="https://fonts.gstatic.com">
		<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@100;300;700&display=swap" rel="stylesheet">
		<style>
			html, body {
				font-family: 'Roboto Mono', monospace;
			}
		</style>
	</head>
	<body xcode>
		<script>
			
			var _max_ball_value = 99;
			var _card_set_length = 8;
			var _card_columns = 5;
			var _card_rows = 5;
			
			function _Round(){
				var _to_daub = null;
				var lastDaub = null;
				this.daubed = null;
				this.daub = function(){
					lastDaub = _to_daub.shift();
					this.daubed.push(lastDaub);
					return lastDaub;
				}
				this.create = function(){
					var r = [];
					var i = 0;
					while(i < _max_ball_value){
						r[i] = ++i;
					}
					_to_daub = [];
					while(r.length > 0){
						_to_daub[_to_daub.length] = r.splice((Math.random() * (r.length-1))>>0, 1)[0];
					}
					this.daubed = [];
				}
				this.toString = function(){
					var r = [
						'Round[]',
						'lastDaub: <b>' + lastDaub + '</b>',
						'daubed: ' + this.daubed.length,
						'remain: ' + _to_daub.length,
					];
					return r.join('\n|\t');
				}
				this.create();
			}
			
			function _Slots(){
				var _len = _card_columns * _card_rows;
				this.values = null;
				this.shuffle = function(){
					var t = [];
					var i = 0;
					while(i < _max_ball_value){
						t[i] = ++i;
					}
					this.values = [];
					while(this.values.length < _len){
						this.values.push(t.splice((Math.random() * (t.length-1))>>0, 1)[0]);
					}
				}
				this.match = function(i){
					return this.values.indexOf(i);
				}
				this.shuffle();
			}
			
			function _Card(id){
				this.id = id;
				this.w = _card_columns;
				this.h = _card_rows;
				this.f = null;
				this.slots = null;
				this.matches = null;
				this.daub = function(i){
					var p = this.slots.match(i);
					if(p != -1){
						var x = p%this.w;
						var y = (p/this.w)>>0;
						var f = (1<<(y*this.w+x));
						if(!((this.f & f) == f)){
							this.f = this.f | f;
							this.matches.col[x] += 1;
							this.matches.row[y] += 1;
							this.matches.score += 1;
							if(this.matches.col[x] == this.h){
								this.matches.columns+=1;
							}
							if(this.matches.row[y] == this.w){
								this.matches.rows+=1;
							}
							if(this.matches.score == this.w * this.h){
								this.matches.full += 1;
							}
						}
					}
				}
				this.getColProgress = function(x){
					return this.matches.col[x];
				}
				this.getRowProgress = function(y){
					return this.matches.row[y];
				}
				this.reset = function(){
					this.f = 0;
					this.slots = new _Slots();
					this.matches = {row:[], col:[], score:0, rows:0, columns:0, full:0};
					while(this.matches.row.length < this.h){
						this.matches.row.push(0);
					}
					while(this.matches.col.length < this.w){
						this.matches.col.push(0);
					}
				}
				this.toString = function(){
					// left block
					var l = this.f.toString(2);
					var o = [];
					while(l.length < this.w * this.h){
						l = '0' + l;
					}
					l = l.split('').reverse();
					l = l.join('');
					// right block
					var r = [];
					for(var i in this.slots.values){
						var v = this.slots.values[i];
						var t = 1<<i;
						var m = (this.f & t) == t;
						r[i] = (m ? '<b>' : '') + (v < 10 ? '0' + v : v) + (m ? '</b>' : '');
					}
					// matches
					
					// merge
					var i = 0;
					while(i < this.h){
						o[i] = l.substr(i * this.w, this.w).split('').join('  ').split('1').join('<b>1</b>') + '   <>   ' + r.splice(0, this.w).join('  ') + ' ←' + this.getRowProgress(i);
						++i;
					}
					var t = '     ';
					i = 0;
					while(i < this.w){
						t += '   ';
						++i;
					}
					i = 0;
					while(i < this.w){
						t += ' ↑' + this.getColProgress(i) + ' ';
						++i;
					}
					o.push(t);
					return 'CARD[] Row x' + this.matches.rows + ' Col x' + this.matches.columns + ' ~ Progress ' + ((this.matches.score<10 ? '0' : '') + this.matches.score + '/' + (this.w*this.h)) + ' ~ #' + this.id + ' [' + this.f + '] \n|\t\t' + o.join('\n|\t\t');
				}
				this.reset();
			}
			
			function _CardSet(){
				this.cards = null;
				this.create = function(){
					this.cards = [];
					while(this.cards.length < _card_set_length){
						this.cards.push(new _Card(this.cards.length));
					}
				}
				this.proccessDaub = function(daub){
					for(var i in this.cards){
						this.cards[i].daub(daub);
					}
				}
				this.toString = function(){
					var r = [];
					for(var card in this.cards){
						card = this.cards[card];
						r[r.length] = card.toString();
					}
					return 'CardSet[' + this.cards.length + ']\n|\n|\t' + r.join('\n|\n|\t') + '|\n|\n';
				}
				this.create();
			}
			
			var Round = new _Round();
			var CardSet = new _CardSet();
			
			Jotun.run(function(){
				function ProcessOneDaub(){
					var daub = Round.daub();
					if(daub != null){
						CardSet.proccessDaub(daub);
						Jotun.one('.CardSet').writeHtml(Round.toString().split('\n').join('<br/>').split(' ').join('&nbsp;').split('\t').join('&nbsp;&nbsp;&nbsp;&nbsp;')+'<br><br>');
						Jotun.one('.CardSet').appendHtml(CardSet.toString().split('\n').join('<br/>').split(' ').join('&nbsp;').split('\t').join('&nbsp;&nbsp;&nbsp;&nbsp;'));
					}
				}
				setInterval(ProcessOneDaub, 250);
				ProcessOneDaub();
			});
			
			
		</script>
		<div class="CardSet"></div>
	</body>
</html>